<!-- Check out the documentation at https://github.com/KaiVandivier/ascend-mda-report -->

<!-- Bootstrap stylesheet -->
<link
  rel="stylesheet"
  href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
  integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
  crossorigin="anonymous"
/>

<style type="text/css" media="screen">
  /* Put your CSS styling here */

  /* Rows that are not category labels */
  th[scope="row"]:not([colspan]) {
    font-weight: normal;
  }

  /* Stripe columns 2, 4-6, 10-12. (simply `even` for top header row) */
  /* THIS IS HARD-CODED AND NEEDS CHANGING IF COLUMNS CHANGE */
  tr#header-row-top > *:nth-child(even),
  tr:not(#header-row-top) > *:nth-child(2),
  tr:not(#header-row-top) > *:nth-child(n + 4):nth-child(-n + 6),
  tr:not(#header-row-top) > *:nth-child(n + 10):nth-child(-n + 12) {
    background-color: #fafafa;
  }
</style>

<script type="text/javascript">
  // Put your javascript functions here

  // Enums for table
  const colSubcats = Object.freeze({
    ROUND_1: { name: "Round 1", shortName: "R1" },
    ROUND_2: { name: "Round 2", shortName: "R2" },
    TOTAL: { name: "Total", shortName: "Tot." },
  });
  const rowTypes = Object.freeze({
    CATEGORY: "category",
    DATA: "data"
  });

  /**
   * Row and column definitions: Edit these to define the table.
   * See the documentation at https://github.com/KaiVandivier/ascend-mda-report
   * for a guide.
   */
  const columns = [
    {
      name: "Trachoma",
      shortName: "Trach.",
      subcategories: null,
    },
    {
      name: "Lymphatic Filariasis",
      shortName: "L.F.",
      subcategories: null,
    },
    {
      name: "Onchocerciasis",
      shortName: "Oncho.",
      subcategories: [colSubcats.ROUND_1, colSubcats.ROUND_2, colSubcats.TOTAL],
    },
    {
      name: "Schistosomiasis",
      shortName: "Schisto.",
      subcategories: [colSubcats.ROUND_1, colSubcats.ROUND_2, colSubcats.TOTAL],
    },
    {
      name: "S.T. Helminthiasis",
      shortName: "STH",
      subcategories: [colSubcats.ROUND_1, colSubcats.ROUND_2, colSubcats.TOTAL],
    },
    {
      name: "Grand Total",
      shortName: "Grand Total",
      subcategories: null,
    },
  ];

  const rows = [
    // Endemicity
    { name: "Endemicity", type: rowTypes.CATEGORY },
    {
      name: "Endemic IUs",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - Endemic IUs" },
        { dn: "LFMDA - Endemic IUs" },
        null,
        null,
        { dn: "OMDA - Endemic IUs" },
        null,
        null,
        { dn: "SCMDA - Endemic IUs" },
        null,
        null,
        { dn: "STMDA - Endemic IUs" },
        null,
      ],
    },
    {
      name: "IUs which reached the criteria to stop MDA",
      type: rowTypes.DATA,
      cells: [
        {
          dn: "TCMDA - IUs which reached the criteria to stop MDA",
        },
        {
          dn: "LFMDA - IUs which reached the criteria to stop MDA",
        },
        null,
        null,
        {
          dn: "OMDA - IUs which reached the criteria to stop MDA",
        },
        null,
        null,
        {
          dn: "SCMDA - IUs which reached the criteria to stop MDA",
        },
        null,
        null,
        {
          dn: "STMDA - IUs which reached the criteria to stop MDA",
        },
        null,
      ],
    },
    {
      name: "IUs in post-treatment surveillance",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - IUs in post-treatment surveillance" },
        { dn: "LFMDA - IUs in post-treatment surveillance" },
        null,
        null,
        { dn: "OMDA - IUs in post-treatment surveillance" },
        null,
        null,
        { dn: "SCMDA - IUs in post-treatment surveillance" },
        null,
        null,
        { dn: "STMDA - IUs in post-treatment surveillance" },
        { customLogic: countIUsWithAtLeastOneResponse },
      ],
    },
    {
      name: "IUs eligible for post MDA surveillance phase",
      type: rowTypes.DATA,
      cells: [
        {
          dn: "TCMDA - IUs eligible for post MDA surveillance phase",
        },
        {
          dn: "LFMDA - IUs eligible for post MDA surveillance phase",
        },
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
      ],
    },
    {
      name: "IUs where NTD endemicity is unknown",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - IUs where NTD endemicity is unknown" },
        { dn: "LFMDA - IUs where NTD endemicity is unknown" },
        null,
        null,
        { dn: "OMDA - IUs where NTD endemicity is unknown" },
        null,
        null,
        { dn: "SCMDA - IUs where NTD endemicity is unknown" },
        null,
        null,
        { dn: "STMDA - IUs where NTD endemicity is unknown" },
        { customLogic: countIUsWithAtLeastOneResponse },
      ],
    },
    {
      name: "Population in NTD affected IUs",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - Population in NTD affected IUs" },
        { dn: "LFMDA - Population in NTD affected IUs" },
        { dn: "OMDA - Population in NTD affected IUs Round 1" },
        { dn: "OMDA - Population in NTD affected IUs Round 2" },
        { dn: "OMDA - Population in NTD affected IUs Total" },
        { dn: "SCMDA - Population in NTD affected IUs Round 1" },
        { dn: "SCMDA - Population in NTD affected IUs Round 2" },
        { dn: "SCMDA - Population in NTD affected IUs Total" },
        { dn: "STMDA - Population in NTD affected IUs Round 1" },
        { dn: "STMDA - Population in NTD affected IUs Round 2" },
        { dn: "STMDA - Population in NTD affected IUs Total" },
        { customLogic: countIUsWithAtLeastOneResponse },
      ],
    },
    {
      name: "IUs eligible for pre-TAS surveys",
      type: rowTypes.DATA,
      cells: [
        null,
        { dn: "LFMDA - IUs eligible for pre-TAS surveys" },
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
      ],
    },
    {
      name: "IUs eligible for TAS/IA surveys",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - IUs eligible for TAS/IA surveys" },
        { dn: "LFMDA - IUs eligible for TAS/IA surveys" },
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
      ],
    },

    // Targets
    { name: "Targets", type: rowTypes.CATEGORY },
    {
      name: "Total Population of IUs",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - Total Population of IUs" },
        { dn: "LFMDA - Total Population of IUs" },
        null,
        null,
        { dn: "OMDA - Total Population of IUs" },
        null,
        null,
        { dn: "SCMDA - Total Population of IUs" },
        null,
        null,
        { dn: "STMDA - Total Population of IUs" },
        { dn: "MDA - Total Population in Endemic IUs" },
      ],
    },
    {
      name: "Population eligible for MDA treatment",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - Population eligible for MDA treatment" },
        { dn: "LFMDA - Population eligible for MDA treatment" },
        {
          dn: "OMDA - Population eligible for MDA treatment Round 1",
        },
        {
          dn: "OMDA - Population eligible for MDA treatment Round 2",
        },
        { dn: "OMDA - Population eligible for MDA treatment Total" },
        {
          dn: "SCMDA - Population eligible for MDA treatment Round 1",
        },
        {
          dn: "SCMDA - Population eligible for MDA treatment Round 2",
        },
        {
          dn: "SCMDA - Population eligible for MDA treatment Total",
        },
        {
          dn: "STMDA - Population eligible for MDA treatment Round 1",
        },
        {
          dn: "STMDA - Population eligible for MDA treatment Round 2",
        },
        {
          dn: "STMDA - Population eligible for MDA treatment Total",
        },
        {
          dn: "MDA - Total Population eligible for MDA treatment of IU",
        },
      ],
    },
    {
      name: "Estimated size of populations with high risk of infection",
      type: rowTypes.DATA,
      cells: [
        {
          dn:
            "TCMDA - Estimated size of populations with high risk of infection",
        },
        {
          dn:
            "LFMDA - Estimated size of populations with high risk of infection",
        },
        {
          dn:
            "OMDA - Estimated size of populations with high risk of infection Round 1",
        },
        {
          dn:
            "OMDA - Estimated size of populations with high risk of infection Round 2",
        },
        {
          dn:
            "OMDA - Total Estimated size of populations with high risk of infection",
        },
        {
          dn:
            "SCMDA - Estimated size of populations with high risk of infection Round 1",
        },
        {
          dn:
            "SCMDA - Estimated size of populations with high risk of infection Round 2",
        },
        {
          dn:
            "SCMDA - Total Estimated size of populations with high risk of infection",
        },
        {
          dn:
            "STMDA - Estimated size of populations with high risk of infection Round 1",
        },
        {
          dn:
            "STMDA - Estimated size of populations with high risk of infection Round 2",
        },
        {
          dn:
            "STMDA - Total Estimated size of populations with high risk of infection",
        },
        {
          dn:
            "MDA - Total Estimated size of populations with high risk of infection",
        },
      ],
    },

    // Coverage
    { name: "Coverage", type: rowTypes.CATEGORY },
    {
      name: "Geographic Coverage",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - Geographic Coverage" },
        { dn: "LFMDA - Geographic Coverage" },
        null,
        null,
        { dn: "OMDA - Geographic Coverage" },
        null,
        null,
        { dn: "SCMDA - Geographic Coverage" },
        null,
        null,
        { dn: "STMDA - Geographic Coverage" },
        null,
      ],
    },
    {
      name: "Program Coverage",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - Program Coverage" },
        { dn: "LFMDA - Program Coverage" },
        { dn: "OMDA - Program Coverage Round 1" },
        { dn: "OMDA - Program Coverage Round 2" },
        null,
        { dn: "SCMDA - Program Coverage Round 1" },
        { dn: "SCMDA - Program Coverage Round 2" },
        null,
        { dn: "STMDA - Program Coverage Round 1" },
        { dn: "STMDA - Program Coverage Round 2" },
        null,
        null,
      ],
    },
    {
      name: "Epidemiological Coverage",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - Epidemiological Coverage" },
        { dn: "LFMDA - Epidemiological Coverage" },
        { dn: "OMDA - Epidemiological Coverage Round 1" },
        { dn: "OMDA - Epidemiological Coverage Round 2" },
        null,
        { dn: "SCMDA - Epidemiological Coverage Round 1" },
        { dn: "SCMDA - Epidemiological Coverage Round 2" },
        null,
        { dn: "STMDA - Epidemiological Coverage Round 1" },
        { dn: "STMDA - Epidemiological Coverage Round 2" },
        null,
        null,
      ],
    },
    {
      name: "IUs reaching targeted program coverage",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - IUs reaching targeted program coverage" },
        { dn: "LFMDA - IUs reaching targeted program coverage" },
        { dn: "OMDA - IUs reaching targeted program coverage Round 1" },
        { dn: "OMDA - IUs reaching targeted program coverage Round 2" },
        null,
        { dn: "SCMDA - IUs reaching targeted program coverage Round 1" },
        { dn: "SCMDA - IUs reaching targeted program coverage Round 2" },
        null,
        { dn: "STMDA - IUs reaching targeted program coverage Round 1" },
        { dn: "STMDA - IUs reaching targeted program coverage Round 2" },
        null,
        null,
      ],
    },
    {
      name:
        "IUs reaching target therapeutic coverage within populations with high risk of infection",
      type: rowTypes.DATA,
      cells: [
        {
          dn:
            "TCMDA - IUs reaching target therapeutic coverage within populations with high risk of infection",
        },
        {
          dn:
            "LFMDA - IUs reaching target therapeutic coverage within populations with high risk of infection",
        },
        {
          dn:
            "OMDA - IUs reaching target therapeutic coverage within populations with high risk of infection Round 1",
        },
        {
          dn:
            "OMDA - IUs reaching target therapeutic coverage within populations with high risk of infection Round 2",
        },
        null,
        {
          dn:
            "SCMDA - IUs reaching target therapeutic coverage within populations with high risk of infection Round 1",
        },
        {
          dn:
            "SCMDA - IUs reaching target therapeutic coverage within populations with high risk of infection Round 2",
        },
        null,
        {
          dn:
            "STMDA - IUs reaching target therapeutic coverage within populations with high risk of infection Round 1",
        },
        {
          dn:
            "STMDA - IUs reaching target therapeutic coverage within populations with high risk of infection Round 2",
        },
        null,
        null,
      ],
    },
    {
      name: "IUs where MDA treatment has been provided",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - IUs where MDA treatment has been provided" },
        { dn: "LFMDA - IUs where MDA treatment has been provided" },
        { dn: "OMDA - IUs where MDA treatment has been provided Round 1" },
        { dn: "OMDA - IUs where MDA treatment has been provided Round 2" },
        null,
        { dn: "SCMDA - IUs where MDA treatment has been provided Round 1" },
        { dn: "SCMDA - IUs where MDA treatment has been provided Round 2" },
        null,
        { dn: "STMDA - IUs where MDA treatment has been provided Round 1" },
        { dn: "STMDA - IUs where MDA treatment has been provided Round 2" },
        null,
        { customLogic: countIUsWithAtLeastOneResponse },
      ],
    },
    {
      name: "MDA treatments distributed to high risk populations",
      type: rowTypes.DATA,
      cells: [
        null,
        {
          dn: "LFMDA - MDA treatments distributed to high risk populations",
        },
        {
          dn:
            "OMDA - MDA treatments distributed to high risk populations Round 1",
        },
        {
          dn:
            "OMDA - MDA treatments distributed to high risk populations Round 2",
        },
        {
          dn:
            "OMDA - Total MDA treatments distributed to high risk populations",
        },
        {
          dn:
            "SCMDA - MDA treatments distributed to high risk populations Round 1",
        },
        {
          dn:
            "SCMDA - MDA treatments distributed to high risk populations Round 2",
        },
        {
          dn:
            "SCMDA - Total MDA treatments distributed to high risk populations",
        },
        {
          dn:
            "STMDA - MDA treatments distributed to high risk populations Round 1",
        },
        {
          dn:
            "STMDA - MDA treatments distributed to high risk populations Round 2",
        },
        {
          dn:
            "STMDA - Total MDA treatments distributed to high risk populations",
        },
        {
          dn: "MDA - Total MDA treatments distributed to high risk populations",
        },
      ],
    },
    {
      name: "Number of PC treatments provided per IU",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - Total Persons Treated" },
        { dn: "LFMDA - Total Persons Treated" },
        { dn: "OMDA - Total Persons Treated Round 1" },
        { dn: "OMDA - Total Persons Treated Round 2" },
        { dn: "OMDA - Total Persons Treated Round 1 AND 2" },
        { dn: "SCMDA - Total Persons Treated Round 1" },
        { dn: "SCMDA - Total Persons Treated Round 2" },
        { dn: "SCMDA - Total Persons Treated Round 1 AND 2" },
        { dn: "STMDA - Total Persons Treated Round 1" },
        { dn: "STMDA - Total Persons Treated Round 2" },
        { dn: "STMDA - Total Persons Treated Round 1 AND 2" },
        { dn: "MDA - Total PC treatments provided" },
      ],
    },
    {
      name: "IUs where MDA campaigns were conducted",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - IUs where MDA campaigns were conducted" },
        { dn: "LFMDA - IUs where MDA campaigns were conducted" },
        { dn: "OMDA - IUs where MDA campaigns were conducted Round 1" },
        { dn: "OMDA - IUs where MDA campaigns were conducted Round 2" },
        { dn: "OMDA - Total IUs where MDA campaigns were conducted" },
        { dn: "SCMDA - IUs where MDA campaigns were conducted Round 1" },
        { dn: "SCMDA - IUs where MDA campaigns were conducted Round 2" },
        { dn: "SCMDA - Total IUs where MDA campaigns were conducted" },
        { dn: "STMDA - IUs where MDA campaigns were conducted Round 1" },
        { dn: "STMDA - IUs where MDA campaigns were conducted Round 2" },
        { dn: "STMDA - Total IUs where MDA campaigns were conducted" },
        null,
      ],
    },
    {
      name: "IUs reaching required therapeutic coverage",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - IUs reaching required therapeutic coverage" },
        { dn: "LFMDA - IUs reaching required therapeutic coverage" },
        { dn: "OMDA - IUs reaching required therapeutic coverage Round 1" },
        { dn: "OMDA - IUs reaching required therapeutic coverage Round 2" },
        null,
        { dn: "SCMDA - IUs reaching required therapeutic coverage Round 1" },
        { dn: "SCMDA - IUs reaching required therapeutic coverage Round 2" },
        null,
        { dn: "STMDA - IUs reaching required therapeutic coverage Round 1" },
        { dn: "STMDA - IUs reaching required therapeutic coverage Round 2" },
        null,
        null,
      ],
    },
    {
      name:
        "Number of people, in population eligible for treatment, receiving MDA treatment",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - Total Persons Treated" },
        { dn: "LFMDA - Total Persons Treated" },
        { dn: "OMDA - Total Persons Treated Round 1" },
        { dn: "OMDA - Total Persons Treated Round 2" },
        { dn: "OMDA - Total Persons Treated Round 1 AND 2" },
        { dn: "SCMDA - Total Persons Treated Round 1" },
        { dn: "SCMDA - Total Persons Treated Round 2" },
        { dn: "SCMDA - Total Persons Treated Round 1 AND 2" },
        { dn: "STMDA - Total Persons Treated Round 1" },
        { dn: "STMDA - Total Persons Treated Round 2" },
        { dn: "STMDA - Total Persons Treated Round 1 AND 2" },
        null,
      ],
    },
    {
      name:
        "Number of People, in population eligible for treatment, not receiving MDA treatment",
      type: rowTypes.DATA,
      cells: [
        {
          dn:
            "TCMDA - People, in population eligible for treatment, not receiving MDA treatment",
        },
        {
          dn:
            "LFMDA - People, in population eligible for treatment, not receiving MDA treatment",
        },
        {
          dn:
            "OMDA - People, in population eligible for treatment, not receiving MDA treatment Round 1",
        },
        {
          dn:
            "OMDA - People, in population eligible for treatment, not receiving MDA treatment Round 2",
        },
        {
          dn:
            "OMDA - Total People, in population eligible for treatment, not receiving MDA treatment",
        },
        {
          dn:
            "SCMDA - People, in population eligible for treatment, not receiving MDA treatment Round 1",
        },
        {
          dn:
            "SCMDA - People, in population eligible for treatment, not receiving MDA treatment Round 2",
        },
        {
          dn:
            "SCMDA - Total People, in population eligible for treatment, not receiving MDA treatment",
        },
        {
          dn:
            "STMDA - People, in population eligible for treatment, not receiving MDA treatment Round 1",
        },
        {
          dn:
            "STMDA - People, in population eligible for treatment, not receiving MDA treatment Round 2",
        },
        {
          dn:
            "STMDA - Total People, in population eligible for treatment, not receiving MDA treatment",
        },
        {
          dn:
            "MDA - Total People, in population eligible for treatment, not receiving MDA treatment",
        },
      ],
    },
    {
      name: "IU supported with NTD MDA treatment planning and coordination",
      type: rowTypes.DATA,
      cells: [
        {
          dn:
            "TCMDA - IU supported with NTD MDA treatment planning and coordination",
        },
        {
          dn:
            "LFMDA - IU supported with NTD MDA treatment planning and coordination",
        },
        {
          dn:
            "OMDA - IU supported with NTD MDA treatment planning and coordination Round 1",
        },
        {
          dn:
            "OMDA - IU supported with NTD MDA treatment planning and coordination Round 2",
        },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        {
          dn:
            "SCMDA - IU supported with NTD MDA treatment planning and coordination Round 1",
        },
        {
          dn:
            "SCMDA - IU supported with NTD MDA treatment planning and coordination Round 2",
        },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        {
          dn:
            "STMDA - IU supported with NTD MDA treatment planning and coordination Round 1",
        },
        {
          dn:
            "STMDA - IU supported with NTD MDA treatment planning and coordination Round 2",
        },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        null,
      ],
    },

    // Coverage evaluation
    { name: "Coverage Evaluation", type: rowTypes.CATEGORY },
    {
      name:
        "IUs where MDA treatment coverage was verified and addressed using SCT",
      type: rowTypes.DATA,
      cells: [
        {
          dn:
            "TCMDA - IUs where MDA treatment coverage was verified and addressed using SCT",
        },
        {
          dn:
            "LFMDA - IUs where MDA treatment coverage was verified and addressed using SCT",
        },
        {
          dn:
            "OMDA - IUs where MDA treatment coverage was verified and addressed using SCT Round 1",
        },
        {
          dn:
            "OMDA - IUs where MDA treatment coverage was verified and addressed using SCT Round 2",
        },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        {
          dn:
            "SCMDA - IUs where MDA treatment coverage was verified and addressed using SCT Round 1",
        },
        {
          dn:
            "SCMDA - IUs where MDA treatment coverage was verified and addressed using SCT Round 2",
        },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        {
          dn:
            "STMDA - IUs where MDA treatment coverage was verified and addressed using SCT Round 1",
        },
        {
          dn:
            "STMDA - IUs where MDA treatment coverage was verified and addressed using SCT Round 2",
        },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        {
          customLogic: countIUsWithAtLeastOneResponse
        },
      ],
    },
    {
      name: "IUs not meeting the cut-off value for SCT",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - IUs not meeting the cut-off value for SCT" },
        { dn: "LFMDA - IUs not meeting the cut-off value for SCT" },
        { dn: "OMDA - IUs not meeting the cut-off value for SCT Round 1" },
        { dn: "OMDA - IUs not meeting the cut-off value for SCT Round 2" },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        { dn: "SCMDA - IUs not meeting the cut-off value for SCT Round 1" },
        { dn: "SCMDA - IUs not meeting the cut-off value for SCT Round 2" },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        { dn: "STMDA - IUs not meeting the cut-off value for SCT Round 1" },
        { dn: "STMDA - IUs not meeting the cut-off value for SCT Round 2" },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        null,
      ],
    },
    {
      name:
        "Number of evaluation areas where mop-up activites were conducted following a SCT",
      dnBase: "",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - IUs where mop-up activities were conducted following a SCT" },
        { dn: "LFMDA - IUs where mop-up activities were conducted following a SCT" },
        { dn: "OMDA - IUs where mop-up activities were conducted following a SCT Round 1" },
        { dn: "OMDA - IUs where mop-up activities were conducted following a SCT Round 2" },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        { dn: "SCMDA - IUs where mop-up activities were conducted following a SCT Round 1" },
        { dn: "SCMDA - IUs where mop-up activities were conducted following a SCT Round 2" },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        { dn: "STMDA - IUs where mop-up activities were conducted following a SCT Round 1" },
        { dn: "STMDA - IUs where mop-up activities were conducted following a SCT Round 2" },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        { customLogic: countIUsWithAtLeastOneResponse }
      ],
    },
    {
      name:
        "Number of IUs for which independent representative coverage surveys according to WHO guidelines were completed",
      dnBase: "",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - IUs where independent representative coverage surveys according to WHO guidelines were completed" },
        { dn: "LFMDA - IUs where independent representative coverage surveys according to WHO guidelines were completed" },
        { dn: "OMDA - IUs where independent representative coverage surveys according to WHO guidelines were completed Round 1" },
        { dn: "OMDA - IUs where independent representative coverage surveys according to WHO guidelines were completed Round 2" },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        { dn: "SCMDA - IUs where independent representative coverage surveys according to WHO guidelines were completed Round 1" },
        { dn: "SCMDA - IUs where independent representative coverage surveys according to WHO guidelines were completed Round 2" },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        { dn: "STMDA - IUs where independent representative coverage surveys according to WHO guidelines were completed Round 1" },
        { dn: "STMDA - IUs where independent representative coverage surveys according to WHO guidelines were completed Round 2" },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        {
          customLogic: (cells, idx) =>
            sumOf(
              cells[0].value,
              cells[1].value,
              cells[4].value,
              cells[7].value,
              cells[10].value
            ),
        },
      ],
    },

    // LNOB
    { name: "LNOB", type: rowTypes.CATEGORY },
    {
      name:
        "Number of people from marginilized groups (LNOB) who received NTD MDA treatment",
      dnBase: "",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - People from marginalized groups (LNOB) receiving NTD MDA treatment" },
        { dn: "LFMDA - People from marginalized groups (LNOB) receiving NTD MDA treatment" },
        { dn: "OMDA - People from marginalized groups (LNOB) receiving NTD MDA treatment Round 1" },
        { dn: "OMDA - People from marginalized groups (LNOB) receiving NTD MDA treatment Round 2" },
        { dn: "OMDA - Total People from marginalized groups (LNOB) receiving NTD MDA treatment" },
        { dn: "SCMDA - People from marginalized groups (LNOB) receiving NTD MDA treatment Round 1" },
        { dn: "SCMDA - People from marginalized groups (LNOB) receiving NTD MDA treatment Round 2" },
        { dn: "SCMDA - Total People from marginalized groups (LNOB) receiving NTD MDA treatment" },
        { dn: "STMDA - People from marginalized groups (LNOB) receiving NTD MDA treatment Round 1" },
        { dn: "STMDA - People from marginalized groups (LNOB) receiving NTD MDA treatment Round 2" },
        { dn: "STMDA - Total People from marginalized groups (LNOB) receiving NTD MDA treatment" },
        {
          // Notice: "receiving" vs "who received"
          dn:
            "MDA - Total people from marginalized groups (LNOB) who received NTD MDA treatment",
        },
      ],
    },
  ];
  // End row & cell definitions

  // Defining initial values for state
  // (Ideally, these would be set by the reports app parameters)
  const period = dhis2.report.periods[0] || "THIS_YEAR";
  const orgUnit = Object.keys(dhis2.report.organisationUnit).length
    ? dhis2.report.organisationUnit.id
    : "GdH306UQ8L8"; // This is the global org-unit
  const dimensionsToQuery = [];

  // App state:
  // TODO: (maybe `rows` should go in here?)
  let state = {
    period,
    orgUnit,
    dimensionsToQuery: [],
  };

  // Functions

  // Helper functions
  function greatestOf(...args) {
    const nums = args.filter((n) => !isNaN(n));
    if (!nums.length) return 0;
    return Math.max(...nums);
  }

  function sumOf(...args) {
    const nums = args.filter((n) => !isNaN(n));
    if (!nums.length) return 0;
    return nums.reduce((sum, n) => sum + Number(n), 0);
  }

  function countIUsWithAtLeastOneResponse(cells) {
    // This function counts all unique IUs with at least one value in this row
    // 1. Build dimensions list for query url
    const dimensions = cells.filter(cell => cell && cell.dId)
      .map(cell => cell.dId)
      .join(";");

    // 2. Query analytics:
    return $.get("../api/analytics", {
      // Second orgunit dimension is hardcoded to IU level
      dimension: `dx:${dimensions},ou:${state.orgUnit};LEVEL-iGO9aN3ZSSi`,
      filter: `pe:${state.period}`,
      skipMeta: true,
    }).then(json => {
      // 3. Get number of unique org units (IUs) with response > 0
      const uniqueOrgUnits = new Map();
      json.rows.forEach(([dimensionId, orgUnitId, value]) => {
        if (!value || value <= 0) return;
        uniqueOrgUnits.set(orgUnitId, true);
      })
      return uniqueOrgUnits.size;
    })
  }

  // Table logic
  function getAllDimensions() {
    // Gets a list of all indicators' and program indicators' names and IDs
    return Promise.all([
      $.get(
        "../api/programIndicators.json?filter=displayName:like:MDA&paging=false"
      ),
      $.get("../api/indicators.json?filter=displayName:like:MDA&paging=false"),
    ]).then((values) => {
      const [{ programIndicators }, { indicators }] = values;
      const allDimensions = [...programIndicators, ...indicators];

      // Convert to a Map where keys are names and values are ids for lookup
      const keyValuePairs = allDimensions.map((dimension) => {
        return [dimension.displayName, dimension.id];
      });
      return new Map(keyValuePairs);
    });
  }

  function populateCellDimensionIds(allDimensions) {
    // Populates dimensionId (`dId`) on cells based on dimensionName
    // Also populates `state.dimensionsToQuery` for analytics query
    const dimensionsToQuery = [];

    // Look up dimension ids by name and add ids to cells
    rows.forEach(({ cells }) => {
      if (!cells) return;

      cells.forEach((cell) => {
        if (!cell) return;
        if (cell.dId) {
          // cell already has `dimensionId`; skip ID lookup
          dimensionsToQuery.push(cell.dId);
          return;
        }
        if (!cell.dn) return;
        const { dn: dimensionName } = cell;

        // Find dimension in map:
        const dimensionId = allDimensions.get(dimensionName);

        if (!dimensionId) {
          cell.value = `(dimension not found: ${dimensionName})`;
          return;
        }

        // Dimension found - add it to list to query and populate cell
        dimensionsToQuery.push(dimensionId);
        cell.dId = dimensionId;
      });
    });

    state = { ...state, dimensionsToQuery };
    return dimensionsToQuery;
  }

  function getAnalyticsData() {
    const { dimensionsToQuery, period, orgUnit } = state;
    // Query analytics API for data
    return $.get("../api/analytics", {
      dimension: `dx:${dimensionsToQuery.join(";")},pe:${period}`,
      filter: `ou:${orgUnit}`,
      skipMeta: true,
    }).then((json) => {
      // convert to a map for easy lookup by ID:
      const keyValuePairs = json.rows.map((row) => [row[0], row[2]]);
      const resultsMap = new Map(keyValuePairs);
      return resultsMap;
    });
  }

  function populateCellValues(analyticsResults) {
    // Use `dimensionId` or `customLogic` to populate `value`
    return Promise.all(rows.map(({ cells }) => {
      if (!cells) return; // Empty row; return

      return Promise.all(cells.map(async (cell, idx, arr) => {
        // (get `idx` and `arr` values for custom logic functions)
        if (!cell) return;
        const { dId: dimensionId, customLogic } = cell;

        if (dimensionId) {
          const data = analyticsResults.get(dimensionId);
          cell.value = data || "-";
          return;
        }

        if (customLogic) {
          cell.value = await customLogic(arr, idx);
          return;
        }
      }));
    }));
  }

  function populateHtmlTableHeader() {
    // Remove "loading"
    $("#loading").remove();

    $("#header-row-top").append(`<th scope="col"></th>`);
    $("#header-row-bottom").append(`<th scope="col"></th>`);
    columns.forEach((col) => {
      if (col.subcategories) {
        // 1. Make the top row th colspan = col.subcategories.length
        $("#header-row-top").append(
          `<th scope="col" colspan="${col.subcategories.length}">${col.name}</th>`
        );
        // 2. Make a bottom row th for each subcategory
        col.subcategories.forEach((subcat) => {
          $("#header-row-bottom").append(
            `<th scope="col">${subcat.shortName}</th>`
          );
        });
        return;
      }
      // Else, th with col name on top header row, empty cell on bottom
      $("#header-row-top").append(`<th scope=col>${col.shortName}</th>`);
      $("#header-row-bottom").append(`<th scope="col"></th>`);
    });
  }

  function populateHtmlTableBodyWithValues() {
    // Clear tbody for fresh rows
    const tbody = $("#tbody").empty();

    // Set up table body to be populated
    const totalColumns =
      1 +
      columns.reduce(
        (sum, column) => sum + (column.subcategories?.length || 1),
        0
      );

    // Set up table body
    rows.forEach((row) => {
      // Make new row element
      const newRow = $(
        `<tr data-name="${row.name}" data-type="${row.type}"></tr>`
      );
      // Add new row to DOM
      tbody.append(newRow);

      if (row.type === rowTypes.CATEGORY) {
        // Row is just a category label (like "Coverage Evaluation"): make one wide cell and return
        newRow.append(
          `<th scope="row" colspan="${totalColumns}">${row.name}</th>`
        );
        return;
      }

      // Add row header with name
      newRow.append(`<th scope="row">${row.name}</th>`);

      if (!row.cells || !row.cells.length) {
        newRow.append(
          `<td colspan="${totalColumns - 1}">No dimensions specified</td>`
        );
        return;
      }

      row.cells.forEach((cell) => {
        // If cell is empty or has no value, make empty cell element
        if (!cell || typeof cell.value === "undefined")
          return newRow.append(`<td></td>`);
        const { value } = cell;
        newRow.append(`<td>${value}</td>`);
      });
    });
  }

  function handleChange(e) {
    // On form change, update state with new "period" or "orgUnit", and query data
    state = { ...state, [e.target.name]: e.target.value };
    $("#tbody").empty().text("Loading data...");
    getAnalyticsData()
      .then(populateCellValues)
      .then(populateHtmlTableBodyWithValues);
  }

  function setUpForm() {
    $("#periodSelect").on("change", handleChange);
    $("#orgUnitSelect").on("change", handleChange);
  }

  jQuery(document).ready(function () {
    // Javascript to be executed after page is loaded here

    getAllDimensions()
      .then(populateCellDimensionIds)
      .then(getAnalyticsData)
      .then(populateCellValues)
      .then(populateHtmlTableHeader)
      .then(populateHtmlTableBodyWithValues)
      .then(setUpForm)
      .catch(console.error);
  });
</script>

<div>
  <!-- HTML Markup to make up report -->
  <h1>MDA Treatment Summary</h1>

  <div class="form-group">
    <label for="periodSelect">Period:</label>
    <select name="period" id="periodSelect" class="form-control">
      <option value="2020">2020</option>
      <option value="2019">2019</option>
    </select>
  </div>

  <div class="form-group">
    <label for="orgUnitSelect">Organisation Unit:</label>
    <select name="orgUnit" id="orgUnitSelect" class="form-control">
      <option value="GdH306UQ8L8">ASCEND (Global)</option>
      <option value="NcFgAaXhz7C">Bangladesh</option>
      <option value="AE6IvE2jiSd">Ethiopia</option>
      <option value="TDzGT1zy5Ay">Kenya</option>
      <option value="Ej29Oagyhzo">Malawi</option>
      <option value="dDWimYQWqK3">Mozambique</option>
      <option value="cDXNddYCdPh">South Sudan</option>
      <option value="FqoRMDOhFAp">Tanzania</option>
      <option value="IHyDQqsAo7k">Tanzania, Zanzibar</option>
      <option value="Yz1I2quJvaQ">Uganda</option>
      <option value="AK2b9x2HipG">Zambia</option>
      <option value="zzkzrWcJnfM">ZZ TEST</option>
    </select>
  </div>

  <p>
    <em
      >A cell showing "-" means that no value exists in the database for that
      dimension.</em
    >
  </p>

  <p id="loading">Loading...</p>

  <table id="table1" class="table">
    <thead id="thead">
      <tr id="header-row-top">
        <!-- Script will populate col headers here -->
      </tr>
      <tr id="header-row-bottom">
        <!-- Script will populate col subheaders here-->
      </tr>
    </thead>
    <tbody id="tbody">
      <!-- Script will populate rows here -->
    </tbody>
  </table>
</div>
