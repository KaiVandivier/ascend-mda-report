<!-- Check out the documentation at https://github.com/KaiVandivier/ascend-mda-report -->

<!-- Bootstrap stylesheet -->
<link
  rel="stylesheet"
  href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
  integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
  crossorigin="anonymous"
/>

<style type="text/css" media="screen">
  /* Put your CSS styling here */

  /* Table styles */
  table {
    border-collapse: separate;
    border-spacing: 0;
  }

  td,
  th {
    background: white;
  }

  /* Stripe columns: headers */
  thead th:nth-child(even) {
    background: #fafafa;
  }

  /* Stripe columns 2, 4-6, 10-12. (simply `even` for top header row) */
  /* THIS IS HARD-CODED AND NEEDS CHANGING IF COLUMNS CHANGE */
  tbody tr *:nth-child(2),
  tbody tr *:nth-child(n + 4):nth-child(-n + 6),
  tbody tr *:nth-child(n + 10):nth-child(-n + 12) {
    background-color: #fafafa;
  }

  /* Table header styles */
  #header-row > th {
    position: sticky;
    top: 0;
  }

  th.container {
    width: auto;
  }

  .bottom-row {
    font-weight: normal;
    font-size: 0.9rem;
    height: calc(0.9rem * 1.5);
  }

  /* Row headers that are not category labels: normal font-weight */
  th[scope="row"]:not([colspan]) {
    font-weight: normal;
  }
</style>

<script type="text/javascript">
  // Put your javascript functions here

  // Enums for table
  const colSubcats = Object.freeze({
    ROUND_1: { name: "Round 1", shortName: "R1" },
    ROUND_2: { name: "Round 2", shortName: "R2" },
    TOTAL: { name: "Total", shortName: "Tot." },
  });
  const rowTypes = Object.freeze({
    CATEGORY: "category",
    DATA: "data",
  });

  /**
   * Row and column definitions: Edit these to define the table.
   * See the documentation at https://github.com/KaiVandivier/ascend-mda-report
   * for a guide.
   */
  const columns = [
    {
      name: "Trachoma",
      shortName: "Trach.",
      subcategories: null,
    },
    {
      name: "Lymphatic Filariasis",
      shortName: "L.F.",
      subcategories: null,
    },
    {
      name: "Onchocerciasis",
      shortName: "Oncho.",
      subcategories: [colSubcats.ROUND_1, colSubcats.ROUND_2, colSubcats.TOTAL],
    },
    {
      name: "Schistosomiasis",
      shortName: "Schisto.",
      subcategories: [colSubcats.ROUND_1, colSubcats.ROUND_2, colSubcats.TOTAL],
    },
    {
      name: "S.T. Helminthiasis",
      shortName: "STH",
      subcategories: [colSubcats.ROUND_1, colSubcats.ROUND_2, colSubcats.TOTAL],
    },
    {
      name: "Grand Total",
      shortName: "Grand Total",
      subcategories: null,
    },
  ];

  const rows = [
    // Endemicity
    { name: "Endemicity", type: rowTypes.CATEGORY },
    {
      name: "Endemic IUs",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - Endemic IUs" },
        { dn: "LFMDA - Endemic IUs" },
        null,
        null,
        { dn: "OMDA - Endemic IUs" },
        null,
        null,
        { dn: "SCMDA - Endemic IUs" },
        null,
        null,
        { dn: "STMDA - Endemic IUs" },
        null,
      ],
    },
    {
      name: "IUs which reached the criteria to stop MDA",
      type: rowTypes.DATA,
      cells: [
        {
          dn: "TCMDA - IUs which reached the criteria to stop MDA",
        },
        {
          dn: "LFMDA - IUs which reached the criteria to stop MDA",
        },
        null,
        null,
        {
          dn: "OMDA - IUs which reached the criteria to stop MDA",
        },
        null,
        null,
        {
          dn: "SCMDA - IUs which reached the criteria to stop MDA",
        },
        null,
        null,
        {
          dn: "STMDA - IUs which reached the criteria to stop MDA",
        },
        null,
      ],
    },
    {
      name: "IUs in post-treatment surveillance",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - IUs in post-treatment surveillance" },
        { dn: "LFMDA - IUs in post-treatment surveillance" },
        null,
        null,
        { dn: "OMDA - IUs in post-treatment surveillance" },
        null,
        null,
        { dn: "SCMDA - IUs in post-treatment surveillance" },
        null,
        null,
        { dn: "STMDA - IUs in post-treatment surveillance" },
        { customLogic: (cells) =>
            uniqueRespondingIUs(cells).then(({ numUniqueIUs }) => numUniqueIUs), },
      ],
    },
    {
      name: "IUs eligible for post MDA surveillance phase",
      type: rowTypes.DATA,
      cells: [
        {
          dn: "TCMDA - IUs eligible for post MDA surveillance phase",
        },
        {
          dn: "LFMDA - IUs eligible for post MDA surveillance phase",
        },
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
      ],
    },
    {
      name: "IUs where NTD endemicity is unknown",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - IUs where NTD endemicity is unknown" },
        { dn: "LFMDA - IUs where NTD endemicity is unknown" },
        null,
        null,
        { dn: "OMDA - IUs where NTD endemicity is unknown" },
        null,
        null,
        { dn: "SCMDA - IUs where NTD endemicity is unknown" },
        null,
        null,
        { dn: "STMDA - IUs where NTD endemicity is unknown" },
        { customLogic: (cells) =>
            uniqueRespondingIUs(cells).then(({ numUniqueIUs }) => numUniqueIUs), },
      ],
    },
    {
      name: "Population in NTD affected IUs",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - Population in NTD affected IUs" },
        { dn: "LFMDA - Population in NTD affected IUs" },
        { dn: "OMDA - Population in NTD affected IUs Round 1" },
        { dn: "OMDA - Population in NTD affected IUs Round 2" },
        { dn: "OMDA - Population in NTD affected IUs Total" },
        { dn: "SCMDA - Population in NTD affected IUs Round 1" },
        { dn: "SCMDA - Population in NTD affected IUs Round 2" },
        { dn: "SCMDA - Population in NTD affected IUs Total" },
        { dn: "STMDA - Population in NTD affected IUs Round 1" },
        { dn: "STMDA - Population in NTD affected IUs Round 2" },
        { dn: "STMDA - Population in NTD affected IUs Total" },
        // The following may need to _sum_ values of unique IUs
        {
          customLogic: (cells, idx) =>
            uniqueRespondingIUs(cells).then(({ sumOfValues }) => sumOfValues),
        },
      ],
    },
    {
      name: "IUs eligible for pre-TAS surveys",
      type: rowTypes.DATA,
      cells: [
        null,
        { dn: "LFMDA - IUs eligible for pre-TAS surveys" },
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
      ],
    },
    {
      name: "IUs eligible for TAS/IA surveys",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - IUs eligible for TAS/IA surveys" },
        { dn: "LFMDA - IUs eligible for TAS/IA surveys" },
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
      ],
    },

    // Targets
    { name: "Targets", type: rowTypes.CATEGORY },
    {
      name: "Total Population of IUs",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - Total Population of IUs" },
        { dn: "LFMDA - Total Population of IUs" },
        null,
        null,
        { dn: "OMDA - Total Population of IUs" },
        null,
        null,
        { dn: "SCMDA - Total Population of IUs" },
        null,
        null,
        { dn: "STMDA - Total Population of IUs" },
        { dn: "MDA - Total Population in Endemic IUs" },
      ],
    },
    {
      name: "Population eligible for MDA treatment",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - Population eligible for MDA treatment" },
        { dn: "LFMDA - Population eligible for MDA treatment" },
        {
          dn: "OMDA - Population eligible for MDA treatment Round 1",
        },
        {
          dn: "OMDA - Population eligible for MDA treatment Round 2",
        },
        { dn: "OMDA - Population eligible for MDA treatment Total" },
        {
          dn: "SCMDA - Population eligible for MDA treatment Round 1",
        },
        {
          dn: "SCMDA - Population eligible for MDA treatment Round 2",
        },
        {
          // Note that this is a regular Indicator (not program indic.)
          dn: "SCMDA - Total Population eligible for MDA treatment",
        },
        {
          dn: "STMDA - Population eligible for MDA treatment Round 1",
        },
        {
          dn: "STMDA - Population eligible for MDA treatment Round 2",
        },
        {
          dn: "STMDA - Population eligible for MDA treatment Total",
        },
        {
          dn: "MDA - Total Population eligible for MDA treatment of IU",
        },
      ],
    },
    {
      name: "Estimated size of populations with high risk of infection",
      type: rowTypes.DATA,
      cells: [
        {
          dn:
            "TCMDA - Estimated size of populations with high risk of infection",
        },
        {
          dn:
            "LFMDA - Estimated size of populations with high risk of infection",
        },
        {
          dn:
            "OMDA - Estimated size of populations with high risk of infection Round 1",
        },
        {
          dn:
            "OMDA - Estimated size of populations with high risk of infection Round 2",
        },
        {
          dn:
            "OMDA - Total Estimated size of populations with high risk of infection",
        },
        {
          dn:
            "SCMDA - Estimated size of populations with high risk of infection Round 1",
        },
        {
          dn:
            "SCMDA - Estimated size of populations with high risk of infection Round 2",
        },
        {
          dn:
            "SCMDA - Total Estimated size of populations with high risk of infection",
        },
        {
          dn:
            "STMDA - Estimated size of populations with high risk of infection Round 1",
        },
        {
          dn:
            "STMDA - Estimated size of populations with high risk of infection Round 2",
        },
        {
          dn:
            "STMDA - Total Estimated size of populations with high risk of infection",
        },
        {
          dn:
            "MDA - Total Estimated size of populations with high risk of infection",
        },
      ],
    },

    // Coverage
    { name: "Coverage", type: rowTypes.CATEGORY },
    {
      name: "Geographic Coverage",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - Geographic Coverage" },
        { dn: "LFMDA - Geographic Coverage" },
        null,
        null,
        { dn: "OMDA - Geographic Coverage" },
        null,
        null,
        { dn: "SCMDA - Geographic Coverage" },
        null,
        null,
        { dn: "STMDA - Geographic Coverage" },
        null,
      ],
    },
    {
      name: "Program Coverage",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - Program Coverage" },
        { dn: "LFMDA - Program Coverage" },
        { dn: "OMDA - Program Coverage Round 1" },
        { dn: "OMDA - Program Coverage Round 2" },
        null,
        { dn: "SCMDA - Program Coverage Round 1" },
        { dn: "SCMDA - Program Coverage Round 2" },
        null,
        { dn: "STMDA - Program Coverage Round 1" },
        { dn: "STMDA - Program Coverage Round 2" },
        null,
        null,
      ],
    },
    {
      name: "Epidemiological Coverage",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - Epidemiological Coverage" },
        { dn: "LFMDA - Epidemiological Coverage" },
        { dn: "OMDA - Epidemiological Coverage Round 1" },
        { dn: "OMDA - Epidemiological Coverage Round 2" },
        null,
        { dn: "SCMDA - Epidemiological Coverage Round 1" },
        { dn: "SCMDA - Epidemiological Coverage Round 2" },
        null,
        { dn: "STMDA - Epidemiological Coverage Round 1" },
        { dn: "STMDA - Epidemiological Coverage Round 2" },
        null,
        null,
      ],
    },
    {
      name: "IUs reaching targeted program coverage",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - IUs reaching targeted program coverage" },
        { dn: "LFMDA - IUs reaching targeted program coverage" },
        { dn: "OMDA - IUs reaching targeted program coverage Round 1" },
        { dn: "OMDA - IUs reaching targeted program coverage Round 2" },
        null,
        { dn: "SCMDA - IUs reaching targeted program coverage Round 1" },
        { dn: "SCMDA - IUs reaching targeted program coverage Round 2" },
        null,
        { dn: "STMDA - IUs reaching targeted program coverage Round 1" },
        { dn: "STMDA - IUs reaching targeted program coverage Round 2" },
        null,
        null,
      ],
    },
    {
      name:
        "IUs reaching target therapeutic coverage within populations with high risk of infection",
      type: rowTypes.DATA,
      cells: [
        {
          dn:
            "TCMDA - IUs reaching target therapeutic coverage within populations with high risk of infection",
        },
        {
          dn:
            "LFMDA - IUs reaching target therapeutic coverage within populations with high risk of infection",
        },
        {
          dn:
            "OMDA - IUs reaching target therapeutic coverage within populations with high risk of infection Round 1",
        },
        {
          dn:
            "OMDA - IUs reaching target therapeutic coverage within populations with high risk of infection Round 2",
        },
        null,
        {
          dn:
            "SCMDA - IUs reaching target therapeutic coverage within populations with high risk of infection Round 1",
        },
        {
          dn:
            "SCMDA - IUs reaching target therapeutic coverage within populations with high risk of infection Round 2",
        },
        null,
        {
          dn:
            "STMDA - IUs reaching target therapeutic coverage within populations with high risk of infection Round 1",
        },
        {
          dn:
            "STMDA - IUs reaching target therapeutic coverage within populations with high risk of infection Round 2",
        },
        null,
        null,
      ],
    },
    {
      name: "IUs where MDA treatment has been provided",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - IUs where MDA treatment has been provided" },
        { dn: "LFMDA - IUs where MDA treatment has been provided" },
        { dn: "OMDA - IUs where MDA treatment has been provided Round 1" },
        { dn: "OMDA - IUs where MDA treatment has been provided Round 2" },
        null,
        { dn: "SCMDA - IUs where MDA treatment has been provided Round 1" },
        { dn: "SCMDA - IUs where MDA treatment has been provided Round 2" },
        null,
        { dn: "STMDA - IUs where MDA treatment has been provided Round 1" },
        { dn: "STMDA - IUs where MDA treatment has been provided Round 2" },
        null,
        { customLogic: (cells) =>
            uniqueRespondingIUs(cells).then(({ numUniqueIUs }) => numUniqueIUs), },
      ],
    },
    {
      name: "MDA treatments distributed to high risk populations",
      type: rowTypes.DATA,
      cells: [
        null,
        {
          dn: "LFMDA - MDA treatments distributed to high risk populations",
        },
        {
          dn:
            "OMDA - MDA treatments distributed to high risk populations Round 1",
        },
        {
          dn:
            "OMDA - MDA treatments distributed to high risk populations Round 2",
        },
        {
          dn:
            "OMDA - Total MDA treatments distributed to high risk populations",
        },
        {
          dn:
            "SCMDA - MDA treatments distributed to high risk populations Round 1",
        },
        {
          dn:
            "SCMDA - MDA treatments distributed to high risk populations Round 2",
        },
        {
          dn:
            "SCMDA - Total MDA treatments distributed to high risk populations",
        },
        {
          dn:
            "STMDA - MDA treatments distributed to high risk populations Round 1",
        },
        {
          dn:
            "STMDA - MDA treatments distributed to high risk populations Round 2",
        },
        {
          dn:
            "STMDA - Total MDA treatments distributed to high risk populations",
        },
        {
          dn: "MDA - Total MDA treatments distributed to high risk populations",
        },
      ],
    },
    {
      name: "Number of PC treatments provided per IU",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - Total Persons Treated" },
        { dn: "LFMDA - Total Persons Treated" },
        { dn: "OMDA - Total Persons Treated Round 1" },
        { dn: "OMDA - Total Persons Treated Round 2" },
        { dn: "OMDA - Total Persons Treated Round 1 AND 2" },
        { dn: "SCMDA - Total Persons Treated Round 1" },
        { dn: "SCMDA - Total Persons Treated Round 2" },
        { dn: "SCMDA - Total Persons Treated Round 1 AND 2" },
        { dn: "STMDA - Total Persons Treated Round 1" },
        { dn: "STMDA - Total Persons Treated Round 2" },
        { dn: "STMDA - Total Persons Treated Round 1 AND 2" },
        { dn: "MDA - Total PC treatments provided" },
      ],
    },
    {
      name: "IUs where MDA campaigns were conducted",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - IUs where MDA campaigns were conducted" },
        { dn: "LFMDA - IUs where MDA campaigns were conducted" },
        { dn: "OMDA - IUs where MDA campaigns were conducted Round 1" },
        { dn: "OMDA - IUs where MDA campaigns were conducted Round 2" },
        { dn: "OMDA - Total IUs where MDA campaigns were conducted" },
        { dn: "SCMDA - IUs where MDA campaigns were conducted Round 1" },
        { dn: "SCMDA - IUs where MDA campaigns were conducted Round 2" },
        { dn: "SCMDA - Total IUs where MDA campaigns were conducted" },
        { dn: "STMDA - IUs where MDA campaigns were conducted Round 1" },
        { dn: "STMDA - IUs where MDA campaigns were conducted Round 2" },
        { dn: "STMDA - Total IUs where MDA campaigns were conducted" },
        null,
      ],
    },
    {
      name: "IUs reaching required therapeutic coverage",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - IUs reaching required therapeutic coverage" },
        { dn: "LFMDA - IUs reaching required therapeutic coverage" },
        { dn: "OMDA - IUs reaching required therapeutic coverage Round 1" },
        { dn: "OMDA - IUs reaching required therapeutic coverage Round 2" },
        null,
        { dn: "SCMDA - IUs reaching required therapeutic coverage Round 1" },
        { dn: "SCMDA - IUs reaching required therapeutic coverage Round 2" },
        null,
        { dn: "STMDA - IUs reaching required therapeutic coverage Round 1" },
        { dn: "STMDA - IUs reaching required therapeutic coverage Round 2" },
        null,
        null,
      ],
    },
    {
      name:
        "People, in population eligible for treatment, receiving MDA treatment",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - Total Persons Treated" },
        { dn: "LFMDA - Total Persons Treated" },
        { dn: "OMDA - Total Persons Treated Round 1" },
        { dn: "OMDA - Total Persons Treated Round 2" },
        // The following one and the other two named like it are standar Indicators
        {
          dn:
            "OMDA - Total People, in population eligible for treatment, receiving MDA treatment",
        },
        { dn: "SCMDA - Total Persons Treated Round 1" },
        { dn: "SCMDA - Total Persons Treated Round 2" },
        {
          dn:
            "SCMDA - Total People, in population eligible for treatment, receiving MDA treatment",
        },
        { dn: "STMDA - Total Persons Treated Round 1" },
        { dn: "STMDA - Total Persons Treated Round 2" },
        {
          dn:
            "STMDA - Total People, in population eligible for treatment, receiving MDA treatment",
        },
        null,
      ],
    },
    {
      name:
        "Number of People, in population eligible for treatment, not receiving MDA treatment",
      type: rowTypes.DATA,
      cells: [
        {
          dn:
            "TCMDA - People, in population eligible for treatment, not receiving MDA treatment",
        },
        {
          dn:
            "LFMDA - People, in population eligible for treatment, not receiving MDA treatment",
        },
        {
          dn:
            "OMDA - People, in population eligible for treatment, not receiving MDA treatment Round 1",
        },
        {
          dn:
            "OMDA - People, in population eligible for treatment, not receiving MDA treatment Round 2",
        },
        {
          dn:
            "OMDA - Total People, in population eligible for treatment, not receiving MDA treatment",
          dId: "aMUoBNLJ21U", // Provided because duplicate name in Ind. and prog.Ind.
        },
        {
          dn:
            "SCMDA - People, in population eligible for treatment, not receiving MDA treatment Round 1",
        },
        {
          dn:
            "SCMDA - People, in population eligible for treatment, not receiving MDA treatment Round 2",
        },
        {
          dn:
            "SCMDA - Total People, in population eligible for treatment, not receiving MDA treatment",
          dId: "OAwgpaRCOvc",
        },
        {
          dn:
            "STMDA - People, in population eligible for treatment, not receiving MDA treatment Round 1",
        },
        {
          dn:
            "STMDA - People, in population eligible for treatment, not receiving MDA treatment Round 2",
        },
        {
          dn:
            "STMDA - Total People, in population eligible for treatment, not receiving MDA treatment",
          dId: "c3F2W3YUOgT",
        },
        {
          dn:
            "MDA - Total People, in population eligible for treatment, not receiving MDA treatment",
        },
      ],
    },
    {
      name: "IU supported with NTD MDA treatment planning and coordination",
      type: rowTypes.DATA,
      cells: [
        {
          dn:
            "TCMDA - IU supported with NTD MDA treatment planning and coordination",
        },
        {
          dn:
            "LFMDA - IU supported with NTD MDA treatment planning and coordination",
        },
        {
          dn:
            "OMDA - IU supported with NTD MDA treatment planning and coordination Round 1",
        },
        {
          dn:
            "OMDA - IU supported with NTD MDA treatment planning and coordination Round 2",
        },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        {
          dn:
            "SCMDA - IU supported with NTD MDA treatment planning and coordination Round 1",
        },
        {
          dn:
            "SCMDA - IU supported with NTD MDA treatment planning and coordination Round 2",
        },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        {
          dn:
            "STMDA - IU supported with NTD MDA treatment planning and coordination Round 1",
        },
        {
          dn:
            "STMDA - IU supported with NTD MDA treatment planning and coordination Round 2",
        },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        null,
      ],
    },

    // Coverage evaluation
    { name: "Coverage Evaluation", type: rowTypes.CATEGORY },
    {
      name:
        "IUs where MDA treatment coverage was verified and addressed using SCT",
      type: rowTypes.DATA,
      cells: [
        {
          dn:
            "TCMDA - IUs where MDA treatment coverage was verified and addressed using SCT",
        },
        {
          dn:
            "LFMDA - IUs where MDA treatment coverage was verified and addressed using SCT",
        },
        {
          dn:
            "OMDA - IUs where MDA treatment coverage was verified and addressed using SCT Round 1",
        },
        {
          dn:
            "OMDA - IUs where MDA treatment coverage was verified and addressed using SCT Round 2",
        },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        {
          dn:
            "SCMDA - IUs where MDA treatment coverage was verified and addressed using SCT Round 1",
        },
        {
          dn:
            "SCMDA - IUs where MDA treatment coverage was verified and addressed using SCT Round 2",
        },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        {
          dn:
            "STMDA - IUs where MDA treatment coverage was verified and addressed using SCT Round 1",
        },
        {
          dn:
            "STMDA - IUs where MDA treatment coverage was verified and addressed using SCT Round 2",
        },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        {
          customLogic: (cells) =>
            uniqueRespondingIUs(cells).then(({ numUniqueIUs }) => numUniqueIUs),
        },
      ],
    },
    {
      name: "IUs not meeting the cut-off value for SCT",
      type: rowTypes.DATA,
      cells: [
        { dn: "TCMDA - IUs not meeting the cut-off value for SCT" },
        { dn: "LFMDA - IUs not meeting the cut-off value for SCT" },
        { dn: "OMDA - IUs not meeting the cut-off value for SCT Round 1" },
        { dn: "OMDA - IUs not meeting the cut-off value for SCT Round 2" },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        { dn: "SCMDA - IUs not meeting the cut-off value for SCT Round 1" },
        { dn: "SCMDA - IUs not meeting the cut-off value for SCT Round 2" },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        { dn: "STMDA - IUs not meeting the cut-off value for SCT Round 1" },
        { dn: "STMDA - IUs not meeting the cut-off value for SCT Round 2" },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        null,
      ],
    },
    {
      name:
        "Number of evaluation areas where mop-up activites were conducted following a SCT",
      dnBase: "",
      type: rowTypes.DATA,
      cells: [
        {
          dn:
            "TCMDA - IUs where mop-up activities were conducted following a SCT",
        },
        {
          dn:
            "LFMDA - IUs where mop-up activities were conducted following a SCT",
        },
        {
          dn:
            "OMDA - IUs where mop-up activities were conducted following a SCT Round 1",
        },
        {
          dn:
            "OMDA - IUs where mop-up activities were conducted following a SCT Round 2",
        },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        {
          dn:
            "SCMDA - IUs where mop-up activities were conducted following a SCT Round 1",
        },
        {
          dn:
            "SCMDA - IUs where mop-up activities were conducted following a SCT Round 2",
        },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        {
          dn:
            "STMDA - IUs where mop-up activities were conducted following a SCT Round 1",
        },
        {
          dn:
            "STMDA - IUs where mop-up activities were conducted following a SCT Round 2",
        },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        { customLogic: (cells) =>
            uniqueRespondingIUs(cells).then(({ numUniqueIUs }) => numUniqueIUs), },
      ],
    },
    {
      name:
        "Number of IUs for which independent representative coverage surveys according to WHO guidelines were completed",
      dnBase: "",
      type: rowTypes.DATA,
      cells: [
        {
          dn:
            "TCMDA - IUs where independent representative coverage surveys according to WHO guidelines were completed",
        },
        {
          dn:
            "LFMDA - IUs where independent representative coverage surveys according to WHO guidelines were completed",
        },
        {
          dn:
            "OMDA - IUs where independent representative coverage surveys according to WHO guidelines were completed Round 1",
        },
        {
          dn:
            "OMDA - IUs where independent representative coverage surveys according to WHO guidelines were completed Round 2",
        },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        {
          dn:
            "SCMDA - IUs where independent representative coverage surveys according to WHO guidelines were completed Round 1",
        },
        {
          dn:
            "SCMDA - IUs where independent representative coverage surveys according to WHO guidelines were completed Round 2",
        },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        {
          dn:
            "STMDA - IUs where independent representative coverage surveys according to WHO guidelines were completed Round 1",
        },
        {
          dn:
            "STMDA - IUs where independent representative coverage surveys according to WHO guidelines were completed Round 2",
        },
        {
          customLogic: (cells, idx) =>
            greatestOf(cells[idx - 1].value, cells[idx - 2].value),
        },
        {
          customLogic: (cells) =>
            uniqueRespondingIUs(cells).then(({ numUniqueIUs }) => numUniqueIUs),
        },
      ],
    },

    // LNOB
    { name: "LNOB", type: rowTypes.CATEGORY },
    {
      name:
        "Number of people from marginilized groups (LNOB) who received NTD MDA treatment",
      dnBase: "",
      type: rowTypes.DATA,
      cells: [
        {
          dn:
            "TCMDA - People from marginalized groups (LNOB) receiving NTD MDA treatment",
        },
        {
          dn:
            "LFMDA - People from marginalized groups (LNOB) receiving NTD MDA treatment",
        },
        {
          dn:
            "OMDA - People from marginalized groups (LNOB) receiving NTD MDA treatment Round 1",
        },
        {
          dn:
            "OMDA - People from marginalized groups (LNOB) receiving NTD MDA treatment Round 2",
        },
        {
          dn:
            "OMDA - Total People from marginalized groups (LNOB) receiving NTD MDA treatment",
        },
        {
          dn:
            "SCMDA - People from marginalized groups (LNOB) receiving NTD MDA treatment Round 1",
        },
        {
          dn:
            "SCMDA - People from marginalized groups (LNOB) receiving NTD MDA treatment Round 2",
        },
        {
          dn:
            "SCMDA - Total People from marginalized groups (LNOB) receiving NTD MDA treatment",
        },
        {
          dn:
            "STMDA - People from marginalized groups (LNOB) receiving NTD MDA treatment Round 1",
        },
        {
          dn:
            "STMDA - People from marginalized groups (LNOB) receiving NTD MDA treatment Round 2",
        },
        {
          dn:
            "STMDA - Total People from marginalized groups (LNOB) receiving NTD MDA treatment",
        },
        {
          // Notice: "receiving" vs "who received"
          dn:
            "MDA - Total people from marginalized groups (LNOB) who received NTD MDA treatment",
        },
      ],
    },
  ];
  // End row & cell definitions

  // Defining initial values for state
  // (Ideally, these would be set by the reports app parameters)
  const period = dhis2.report.periods[0] || "THIS_YEAR";
  const orgUnit = Object.keys(dhis2.report.organisationUnit).length
    ? dhis2.report.organisationUnit.id
    : "GdH306UQ8L8"; // This is the global org-unit
  const dimensionsToQuery = [];

  // App state:
  // TODO: (maybe `rows` should go in here?)
  let state = {
    period,
    orgUnit,
    dimensionsToQuery: [],
  };

  // Functions

  // Custom logic helper functions
  function greatestOf(...args) {
    const nums = args.filter((n) => !isNaN(n));
    if (!nums.length) return 0;
    return Math.max(...nums);
  }

  function sumOf(...args) {
    const nums = args.filter((n) => !isNaN(n));
    if (!nums.length) return 0;
    return nums.reduce((sum, n) => sum + Number(n), 0);
  }

  function uniqueRespondingIUs(cells) {
    // This function counts all unique IUs with at least one value in this row
    // 1. Build dimensions list for query url
    const dimensions = cells
      .filter((cell) => cell && cell.dId)
      .map((cell) => cell.dId)
      .join(";");

    // 2. Query analytics:
    return $.get("../api/analytics", {
      // Second orgunit dimension is hardcoded to IU level
      dimension: `dx:${dimensions},ou:${state.orgUnit};LEVEL-iGO9aN3ZSSi`,
      filter: `pe:${state.period}`,
      skipMeta: true,
    })
      .then((json) => {
        // 3. Get unique org units (IUs) with response > 0
        const uniqueOrgUnits = new Map();
        json.rows.forEach(([dimensionId, orgUnitId, value]) => {
          if (!value) return;

          // If this org unit is a duplicate in the list, set value to be the greater
          const existingValue = uniqueOrgUnits.get(orgUnitId);
          if (existingValue) {
            const greaterValue = greatestOf(value, existingValue);
            uniqueOrgUnits.set(orgUnitId, greaterValue);
            return;
          }

          // Otherwise, set value
          uniqueOrgUnits.set(orgUnitId, value);
        });

        let sumOfValues = 0;
        uniqueOrgUnits.forEach((value) => {
          if (isNaN(value)) return;
          sumOfValues += Number(value);
        });
        const numUniqueIUs = uniqueOrgUnits.size;

        return { numUniqueIUs, sumOfValues };
      })
      .catch((err) => {
        console.error("uniqueRespondingIUs() error:", err);
        return "Oops! There was an error.";
      });
  }

  // Table logic
  function getAllDimensions() {
    // Gets a list of all indicators' and program indicators' names and IDs
    return Promise.all([
      $.get(
        "../api/programIndicators.json?filter=displayName:like:MDA&paging=false"
      ),
      $.get("../api/indicators.json?filter=displayName:like:MDA&paging=false"),
    ]).then((values) => {
      const [{ programIndicators }, { indicators }] = values;
      const allDimensions = [...programIndicators, ...indicators];

      const dimensionMap = new Map();
      allDimensions.forEach((dimension) => {
        if (dimensionMap.get(dimension.displayName))
          console.log(
            "Duplicate dimension name found: ",
            dimension.displayName
          );

        // As of right now, overwrite to give last-queried group precedence
        dimensionMap.set(dimension.displayName, dimension.id);
      });
      return dimensionMap;
    });
  }

  function populateCellDimensionIds(allDimensions) {
    // Populates dimensionId (`dId`) on cells based on dimensionName
    // Also populates `state.dimensionsToQuery` for analytics query
    const dimensionsToQuery = [];

    // Look up dimension ids by name and add ids to cells
    rows.forEach(({ cells }) => {
      if (!cells) return;

      cells.forEach((cell) => {
        if (!cell) return;
        if (cell.dId) {
          // cell already has `dimensionId`; skip ID lookup
          dimensionsToQuery.push(cell.dId);
          return;
        }
        if (!cell.dn) return;
        const { dn: dimensionName } = cell;

        // Find dimension in map:
        const dimensionId = allDimensions.get(dimensionName);

        if (!dimensionId) {
          cell.value = `(dimension not found: ${dimensionName})`;
          return;
        }

        // Dimension found - add it to list to query and populate cell
        dimensionsToQuery.push(dimensionId);
        cell.dId = dimensionId;
      });
    });

    state = { ...state, dimensionsToQuery };
    return dimensionsToQuery;
  }

  function getAnalyticsData() {
    // Query analytics API for data (with one monolithic query)
    const { dimensionsToQuery, period, orgUnit } = state;

    return $.get("../api/analytics", {
      dimension: `dx:${dimensionsToQuery.join(";")},pe:${period}`,
      filter: `ou:${orgUnit}`,
      skipMeta: true,
    })
      .then((json) => {
        // convert to a map for easy lookup by ID:
        const keyValuePairs = json.rows.map((row) => [row[0], row[2]]);
        const resultsMap = new Map(keyValuePairs);
        return resultsMap;
      })
      .catch((err) => {
        // There was an error with the monolothic query. Fall back to individual queries

        // Log error and notify user
        console.error(
          "There was an error with the monolithic query. Falling back to individual queries.",
          err
        );
        const errMsgExists = $("#errMsg").length;
        if (!errMsgExists) {
          $("#loading").prepend(`
            <div id="errMsg">
              <p>Oops! There was a hiccup with the database.  This will take a bit longer than usual.</p>
              <p>Check the console for error info.</p>
            </div>
          `);
        }

        // Query dimensions individually to sort out errors
        return getAnalyticsDataIndividually();
      });
  }

  function getAnalyticsDataIndividually() {
    // Query each cell individually to sort out errors
    // (This is much slower and should only be used if there is a db error)
    const { dimensionsToQuery, period, orgUnit } = state;

    return Promise.all(
      dimensionsToQuery.map((dimensionId) => {
        // Query individual cell contents
        return $.get("../api/analytics", {
          dimension: `dx:${dimensionId},pe:${period}`,
          filter: `ou:${orgUnit}`,
          skipMeta: true,
        }).then(
          // If successful, return key-value pair of data
          (json) => {
            if (!json.rows.length) return;
            return [dimensionId, json.rows[0][2]];
          },
          // If unsuccessful, log error and make key-value pair of id and error message
          (err) => {
            console.error(
              `Analytics query error found for dimension ID ${dimensionId}: `,
              err
            );
            const { status, statusText, responseJSON } = err;
            const errorMessage = `(Err ${status}: ${
              responseJSON ? responseJSON.message : statusText
            })`;

            return [dimensionId, errorMessage];
          }
        );
      })
    ).then((kvPairs) => {
      // Turn key-value pairs into a map for lookup during table population
      const filteredPairs = kvPairs.filter((pair) => pair);
      const resultsMap = new Map(filteredPairs);
      return resultsMap;
    });
  }

  function populateCellValues(analyticsResults) {
    // Use `dimensionId` or `customLogic` to populate `value`
    return Promise.all(
      rows.map(async ({ cells }) => {
        if (!cells) return; // Empty row; return

        // Execute (possibly async) cell logic in series
        return cells
          .reduce((prevTask, cell, idx, arr) => {
            return prevTask.then(async () => {
              if (!cell) return;
              const { dId: dimensionId, customLogic } = cell;

              if (dimensionId) {
                const data = analyticsResults.get(dimensionId);
                cell.value = data || "-";
                return;
              }

              if (customLogic) {
                cell.value = await customLogic(arr, idx);
                return;
              }
            });
          }, Promise.resolve())
          .catch(console.error.bind(console, "Cell population error: "));
      })
    );
  }

  function populateHtmlTableHeader() {
    // Empty cell over row names (Maybe "indicator?")
    $("#header-row").append(`<th scope="col"></th>`);
    columns.forEach((col) => {
      const colspan = col.subcategories ? col.subcategories.length : 1;
      const subheadings = col.subcategories
        ? col.subcategories.map((sc) => sc.shortName)
        : null;

      const newHeader = $(`
        <th scope="col" class="container" colspan="${colspan}">
          <div class="row mb-2">
            <span class="col">${subheadings ? col.name : col.shortName}</span>
          </div>
        </th>
      `);
      $("#header-row").append(newHeader);

      const bottomRow = $(`<div class="row no-gutters bottom-row"></div>`);
      newHeader.append(bottomRow);

      if (subheadings) {
        subheadings.forEach((subheading) =>
          bottomRow.append(`<span class="col">${subheading}</span>`)
        );
        return;
      }
    });
  }

  function populateHtmlTableBodyWithValues() {
    // Clear tbody for fresh rows & remove "loading"
    const tbody = $("#tbody").empty();
    $("#loading").hide();
    const numberFormat = new Intl.NumberFormat(undefined, {
      maximumFractionDigits: 2,
    });

    // Set up table body to be populated
    const totalColumns =
      1 +
      columns.reduce(
        (sum, column) => sum + (column.subcategories?.length || 1),
        0
      );

    // Set up table body
    rows.forEach((row) => {
      // Make new row element
      const newRow = $(
        `<tr data-name="${row.name}" data-type="${row.type}"></tr>`
      );
      // Add new row to DOM
      tbody.append(newRow);

      if (row.type === rowTypes.CATEGORY) {
        // Row is just a category label (like "Coverage Evaluation"): make one wide cell and return
        newRow.append(
          `<th scope="row" colspan="${totalColumns}">${row.name}</th>`
        );
        return;
      }

      // Add row header with name
      newRow.append(`<th scope="row">${row.name}</th>`);

      if (!row.cells || !row.cells.length) {
        newRow.append(
          `<td colspan="${totalColumns - 1}">No dimensions specified</td>`
        );
        return;
      }

      row.cells.forEach((cell) => {
        // If cell is empty or has no value, make empty cell element
        if (!cell || typeof cell.value === "undefined")
          return newRow.append(`<td></td>`);
        const { value } = cell;
        const formattedValue = isNaN(value)
          ? value
          : numberFormat.format(Number(value));
        newRow.append(`<td>${formattedValue}</td>`);
      });
    });
  }

  function handleChange(e) {
    // On form change, update state with new "period" or "orgUnit", and query data
    state = { ...state, [e.target.name]: e.target.value };

    // Prepare for reload & show loading
    $("#tbody").empty();
    $("#loading").show();

    // Query new data and populate table
    getAnalyticsData()
      .then(populateCellValues)
      .then(populateHtmlTableBodyWithValues);
  }

  function setUpForm() {
    $("#periodSelect").on("change", handleChange);
    $("#orgUnitSelect").on("change", handleChange);
  }

  jQuery(document).ready(function () {
    // Javascript to be executed after page is loaded here

    populateHtmlTableHeader();
    getAllDimensions()
      .then(populateCellDimensionIds)
      .then(getAnalyticsData)
      .then(populateCellValues)
      .then(populateHtmlTableBodyWithValues)
      .then(setUpForm)
      .catch(console.error);
  });
</script>

<div>
  <!-- HTML Markup to make up report -->
  <h1>MDA Treatment Summary</h1>

  <div class="form-group">
    <label for="periodSelect">Period:</label>
    <select name="period" id="periodSelect" class="form-control">
      <option value="2020">2020</option>
      <option value="2019">2019</option>
    </select>
  </div>

  <div class="form-group">
    <label for="orgUnitSelect">Organisation Unit:</label>
    <select name="orgUnit" id="orgUnitSelect" class="form-control">
      <option value="GdH306UQ8L8">ASCEND (Global)</option>
      <option value="NcFgAaXhz7C">Bangladesh</option>
      <option value="AE6IvE2jiSd">Ethiopia</option>
      <option value="TDzGT1zy5Ay">Kenya</option>
      <option value="Ej29Oagyhzo">Malawi</option>
      <option value="dDWimYQWqK3">Mozambique</option>
      <option value="cDXNddYCdPh">South Sudan</option>
      <option value="FqoRMDOhFAp">Tanzania</option>
      <option value="IHyDQqsAo7k">Tanzania, Zanzibar</option>
      <option value="Yz1I2quJvaQ">Uganda</option>
      <option value="AK2b9x2HipG">Zambia</option>
      <option value="zzkzrWcJnfM">ZZ TEST</option>
    </select>
  </div>

  <p>
    <em
      >A cell showing "-" means that no value exists in the database for that
      dimension.</em
    >
  </p>

  <table id="table1" class="table">
    <thead id="thead">
      <tr id="header-row">
        <!-- Script will populate col headers here -->
      </tr>
    </thead>
    <tbody id="tbody">
      <!-- Script will populate rows here -->
    </tbody>
  </table>

  <div id="loading" class="text-center">
    <p>Loading...</p>
    <div class="spinner-border" role="status">
      <span class="sr-only">Loading...</span>
    </div>
  </div>
</div>
