<style type="text/css" media="screen">
  /* Put your CSS styling here */
</style>

<script type="text/javascript">
  // Put your javascript functions here

  jQuery(document).ready(function () {
    // Put javascript to be executed after page is loaded here

    /* Start boilerplate */
    // This is not working b/c orgunit/period error in forms
    // const orgUnit = dhis2.report.organisationUnit; // An object
    // const id = orgUnit.id;
    // const name = orgUnit.name;
    // const code = orgUnit.code;

    // const orgUnitHierarchy = dhis2.report.organisationUnitHierarchy; // An array with org unit objects for the hierarchy (current org unit first)
    // const name = orgUnitHierarchy[0].name;

    // const orgUnitChildren = dhis2.report.organisationUnitChildren; // An array with child org unit objects

    // const date = dhis2.report.date; // A date in yyyy-MM-dd format

    // const periods = dhis2.report.periods; // An array with period identifiers
    // const period = periods[0];
    /** End boilerplate */

    // Defining these values here because form creation error isn't saving report parameter settings
    const period = "THIS_MONTH";
    const orgUnit = "GdH306UQ8L8"; // This is the global org-unit

    // Test out fetching with query params as an object
    // $.get(
    //   "../api/programIndicators.json",
    //   {
    //     filter: "displayName:like:TCMDA",
    //   },
    //   console.log
    // );

    // Test out fetching programIndicator list
    $.get(
      "../api/programIndicators.json?filter=displayName:like:MDA&paging=false",
      (json) => {
        const { programIndicators } = json;

        /* Setting up a table */
        // Some enums I might use
        const columnSubcategories = Object.freeze({
          ROUND_1: "Round 1",
          ROUND_2: "Round 2",
          TOTAL: "Total",
        });
        const rowTypes = Object.freeze({
          CATEGORY: "category",
          PROGRAM_INDICATOR: "programIndicator",
          INDICATOR: "indicator",
        });
        // Enum for program indicator names? -- Maybe not, just put it in `rows`

        // Column and row values
        // TODO: Add short names
        const columns = [
          {
            name: "Trachoma MDA",
            shortName: "Trach.",
            prefix: "TCMDA",
            subcategories: null,
          },
          {
            name: "Lymphatic Filariasis MDA",
            shortName: "LF",
            prefix: "LFMDA",
            subcategories: null,
          },
          {
            name: "Onchopsoriasis MDA",
            shortName: "Oncho.",
            prefix: "OMDA",
            subcategories: [
              columnSubcategories.ROUND_1,
              columnSubcategories.ROUND_2,
              columnSubcategories.TOTAL,
            ],
          }, // Maybe use `.subcategories: [...]`
          {
            name: "Schistosomiasis MDA",
            shortName: "Schisto.",
            prefix: "SCMDA",
            subcategories: [
              columnSubcategories.ROUND_1,
              columnSubcategories.ROUND_2,
              columnSubcategories.TOTAL,
            ],
          },
          {
            name: "Soil-transmitted Helminth MDA",
            shortName: "STH",
            prefix: "STMDA",
            subcategories: [
              columnSubcategories.ROUND_1,
              columnSubcategories.ROUND_2,
              columnSubcategories.TOTAL,
            ],
          },
        ];

        const rows = [
          // Endemicity
          { name: "Endemicity", type: rowTypes.CATEGORY },
          { name: "Endemic IUs", type: rowTypes.PROGRAM_INDICATOR },
          {
            name: "IUs which reached the criteria to stop MDA",
            type: rowTypes.PROGRAM_INDICATOR,
          },
          {
            name: "IUs in post-treatment surveillance",
            type: rowTypes.PROGRAM_INDICATOR,
          },
          {
            name: "IUs eligible for post MDA surveillance phase",
            type: rowTypes.PROGRAM_INDICATOR,
          },
          {
            name: "IUs where NTD endemicity is unknown",
            type: rowTypes.PROGRAM_INDICATOR,
          },
          {
            name: "Population in NTD affected IUs",
            type: rowTypes.PROGRAM_INDICATOR,
          },
          {
            name: "IUs eligible for pre-TAS surveys",
            type: rowTypes.PROGRAM_INDICATOR,
          },
          {
            name: "IUs eligible for TAS/IA surveys",
            type: rowTypes.PROGRAM_INDICATOR,
          },
          // Targets
          { name: "Targets", type: rowTypes.CATEGORY },
          { name: "Total Population of IUs", type: rowTypes.PROGRAM_INDICATOR },
          {
            name: "Population eligible for MDA treatment",
            type: rowTypes.PROGRAM_INDICATOR,
          },
          {
            name: "Estimated size of populations with high risk of infection",
            type: rowTypes.PROGRAM_INDICATOR,
          },
          // ... more to come
        ];

        // Set up column headers and subheaders
        $("#header-row-top").append(`<th scope="col">Category</th>`);
        $("#header-row-bottom").append(`<th scope="col"></th>`);
        columns.forEach((col) => {
          if (col.subcategories) {
            // 1. Make the top row th colspan = col.subcategories.length
            $("#header-row-top").append(
              `<th scope="col" colspan="${col.subcategories.length}">${col.name}</th>`
            );
            // 2. Make a bottom row th for each subcategory
            col.subcategories.forEach((sc) => {
              $("#header-row-bottom").append(`<th scope="col">${sc}</th>`);
            });
            return;
          }
          // Else, th with col name on top header row, empty cell on bottom
          $("#header-row-top").append(`<th scope=col>${col.shortName}</th>`);
          $("#header-row-bottom").append(`<th scope="col"></th>`);
        });

        // Set up table body to be populated
        const totalColumns =
          1 +
          columns.reduce(
            (sum, column) =>
              sum + (column.subcategories ? column.subcategories.length : 1),
            0
          );
        const dimensionsToQuery = [];
        const tbody = $("#tbody");

        rows.forEach((row) => {
          // Make new row object
          const newRow = $(`<tr id=${row.name}></tr>`);
          // Add new row to DOM
          tbody.append(newRow);

          if (row.type === rowTypes.CATEGORY) {
            // If row is just a category, make one wide cell and return
            newRow.append(
              `<th scope="row" colspan="${totalColumns}">${row.name}</th>`
            );
            return;
          }

          // Add row header with name
          newRow.append(`<th scope="row">${row.name}</th>`);
          // Add data cells
          columns.forEach((col) => {
            // 1. Check if column has subcategories
            if (col.subcategories) {
              // Subcategory strategy:
              // A. Check for aggregate dimension (without suffix)
              // If present, add empty cells for "rounds" and a cell with data in "total"; return
              const dimensionName = `${col.prefix} - ${row.name}`; // e.g. "TMDA - Endemic IUs"
              const dimension = programIndicators.find(
                (dim) => dim.displayName === dimensionName
              );
              if (dimension) {
                col.subcategories.forEach((subcategory) => {
                  // Empty cells if not in "Total" column
                  if (subcategory !== columnSubcategories.TOTAL) {
                    newRow.append("<td></td>");
                    return;
                  }
                  // Data for "total" column
                  newRow.append(
                    `<td data-dim-id=${dimension.id}>Loading...</td>`
                  );
                  // Add dimension to list to query
                  dimensionsToQuery.push(dimension.id);
                });
                return;
              }

              // B. Check for subcategory dimension
              // If present, add filled cells for each subcat
              col.subcategories.forEach((subcategory) => {
                const subcatDimensionName = `${dimensionName} ${subcategory}`; // e.g. "OMDA - Population in NTD affected IUs Round 2"

                const subcatDimension = programIndicators.find(
                  (dim) => dim.displayName === subcatDimensionName
                );

                if (subcatDimension) {
                  // Dimension found: make new cell and return
                  const dimensionId = subcatDimension.id;
                  // Make cell; give it a target to be filled with data
                  newRow.append(
                    `<td data-dim-id=${dimensionId}>Loading...</td>`
                  );
                  // Add dimension to list to query
                  dimensionsToQuery.push(dimensionId);
                  return;
                }

                // Dimension not found; add cell with message
                newRow.append(`<td>(dimension not found)</td>`);
              });
              return; // Done with subcategories
            }

            // 2. If no subcategories, look for data for cell (use row name & col prefix)
            const dimensionName = `${col.prefix} - ${row.name}`; // e.g. "TCMDA - Endemic IUs"

            // TODO: Use indicators / programIndicators / other
            const dimension = programIndicators.find(
              (dim) => dim.displayName === dimensionName
            );

            if (dimension) {
              const dimensionId = dimension.id;
              // Make cell; give it a target to be filled with data
              newRow.append(`<td data-dim-id=${dimensionId}>Loading...</td>`);
              // Add dimension to list to query
              dimensionsToQuery.push(dimensionId);
            }

            // TODO: Maybe, if data is not found, check /api/programIndicators with case insensitivity to see if field exists
          });
        }); // End table body row population

        // API call to fetch analytics data
        $.get(
          "../api/analytics",
          {
            dimension: `dx:${dimensionsToQuery.join(";")},pe:${period}`,
            filter: `ou:${orgUnit}`,
            skipMeta: true,
          },
          (json) => {
            // Fill cells that returned data; put "-" in ones that didn't
            dimensionsToQuery.forEach((dim) => {
              const cellContent =
                json.rows.find((row) => row[0] === dim)?.[2] || "-";
              $(`td[data-dim-id=${dim}`).text(cellContent);
            });
          }
        );
      }
    ); // End $.get
  });
</script>

<!-- Bootstrap test -->
<link
  rel="stylesheet"
  href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
  integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
  crossorigin="anonymous"
/>

<div>
  <!-- Put your HTML mark-up here -->

  <h1>Table test</h1>

  <table id="table1" class="table">
    <thead id="thead">
      <tr id="header-row-top">
        <!-- Script will populate col headers here -->
      </tr>
      <tr id="header-row-bottom">
        <!-- Script will populate col subheaders here-->
      </tr>
    </thead>
    <tbody id="tbody">
      <!-- Script will populate rows here -->
    </tbody>
  </table>

  <!-- Remove all content after this line after reading it -->

  <h3>This is a template for HTML/javascript based reports</h3>

  <p>
    You have the jQuery javascript library at your disposal when writing
    reports. It can be accessed with the usual jQuery or $ symbols.
  </p>

  <p>
    You can embed javascript through the usual &lt;script
    type="text/javascript"&gt;&lt;script&gt; tag. You can embed CSS styling
    through the usual &lt;style type="text/css"&gt;&lt;style&gt; tag. You should
    not include &lt;html&gt;, &lt;body&gt; or &lt;head&gt; tags in your report.
  </p>

  <p>
    You can utilize the DHIS 2 Web API to render meta-data and data in your
    report. The Web API can be accessed from ../api. For instance, to retrieve
    the first page of data elements in JSON format you can link to
    ../api/dataElements.json. To get access to aggregate data you can utilize
    the analytics resource at ../api/analytics.
  </p>

  <p>
    HTML-based standard reports can use relative periods and report parameters
    in the same way as other types of standard reports. If you select relative
    periods or report parameters for period and organisation unit, you can
    access the resulting periods and organisation unit in the dhis2.report
    javascript namespace like below:
  </p>

  <p>
    Right-click and view page source to see the structure of this template. You
    can upload your HTML report through the "add new report" screen in DHIS 2
    under "design file".
  </p>

  <p>
    jQuery documentation can be found
    <a href="http://docs.jquery.com/">here</a>. DHIS 2 Web API documentation can
    be found
    <a href="http://dhis2.org/doc/snapshot/en/user/html/ch23.html">here</a>.
  </p>
</div>
