<style type="text/css" media="screen">
  /* Put your CSS styling here */

  /* Rows that are not category labels */
  th[scope="row"]:not([colspan]) {
    font-weight: normal;
  }
</style>

<script type="text/javascript">
  // Put your javascript functions here

  // Constants
  const allOrgUnits = [
    { id: "GdH306UQ8L8", displayName: "ASCEND (Global)" },
    { id: "NcFgAaXhz7C", displayName: "Bangladesh" },
    { id: "AE6IvE2jiSd", displayName: "Ethiopia" },
    { id: "TDzGT1zy5Ay", displayName: "Kenya" },
    { id: "Ej29Oagyhzo", displayName: "Malawi" },
    { id: "dDWimYQWqK3", displayName: "Mozambique" },
    { id: "cDXNddYCdPh", displayName: "South Sudan" },
    { id: "FqoRMDOhFAp", displayName: "Tanzania" },
    { id: "IHyDQqsAo7k", displayName: "Tanzania, Zanzibar" },
    { id: "Yz1I2quJvaQ", displayName: "Uganda" },
    { id: "AK2b9x2HipG", displayName: "Zambia" },
    { id: "zzkzrWcJnfM", displayName: "ZZ TEST" },
  ];
  // Enums for table
  const colSubcats = Object.freeze({
    ROUND_1: { name: "Round 1", shortName: "R1" },
    ROUND_2: { name: "Round 2", shortName: "R2" },
    TOTAL: { name: "Total", shortName: "Tot." },
  });
  const rowTypes = Object.freeze({
    CATEGORY: "category",
    PROGRAM_INDICATOR: "programIndicator",
    INDICATOR: "indicator",
  });
  const columns = [
    {
      name: "Trachoma",
      shortName: "Trach.",
      prefix: "TCMDA",
      subcategories: null,
    },
    {
      name: "Lymphatic Filariasis",
      shortName: "L.F.",
      prefix: "LFMDA",
      subcategories: null,
    },
    {
      name: "Onchocerciasis",
      shortName: "Oncho.",
      prefix: "OMDA",
      subcategories: [colSubcats.ROUND_1, colSubcats.ROUND_2, colSubcats.TOTAL],
    },
    {
      name: "Schistosomiasis",
      shortName: "Schisto.",
      prefix: "SCMDA",
      subcategories: [colSubcats.ROUND_1, colSubcats.ROUND_2, colSubcats.TOTAL],
    },
    {
      name: "S.T. Helminthiasis",
      shortName: "STH",
      prefix: "STMDA",
      subcategories: [colSubcats.ROUND_1, colSubcats.ROUND_2, colSubcats.TOTAL],
    },
    {
      name: "Grand Total",
      shortName: "Grand Total",
      prefix: null,
      subcategories: null,
    },
  ];

  // Defining initial values for state
  const period = dhis2.report.periods[0] || "THIS_YEAR";
  const orgUnit = dhis2.report.organisationUnit.length
    ? dhis2.report.organisationUnit.id
    : "GdH306UQ8L8"; // This is the global org-unit
  const dimensionsToQuery = [];

  // App state:
  // TODO: (maybe `rows` should go in here)
  let state = {
    period,
    orgUnit,
    dimensionsToQuery: [],
  };

  // If cell definitions are not manually defined, they are estimated based on row / title info
  // `dn` is "dimensionName"
  // `customLogic`: a function that should return the value for the cell. Receives its index and the current row array as arguments: customLogic: (idx, row) => {...}
  // Custom logic will be called while the cells are being populated with data; it will only have access to previous cells in the tabl.
  const rows = [
    // Endemicity
    { name: "Endemicity", type: rowTypes.CATEGORY },
    {
      name: "Endemic IUs",
      type: rowTypes.PROGRAM_INDICATOR,
      cells: [
        { dn: "TCMDA - Endemic IUs" },
        { dn: "LFMDA - Endemic IUs" },
        null,
        null,
        { dn: "OMDA - Endemic IUs" },
        null,
        null,
        { dn: "SCMDA - Endemic IUs" },
        null,
        null,
        { dn: "STMDA - Endemic IUs" },
        null,
      ],
    },
    {
      name: "IUs which reached the criteria to stop MDA",
      type: rowTypes.PROGRAM_INDICATOR,
      cells: [
        {
          dn: "TCMDA - IUs which reached the criteria to stop MDA",
        },
        {
          dn: "LFMDA - IUs which reached the criteria to stop MDA",
        },
        null,
        null,
        {
          dn: "OMDA - IUs which reached the criteria to stop MDA",
        },
        null,
        null,
        {
          dn: "SCMDA - IUs which reached the criteria to stop MDA",
        },
        null,
        null,
        {
          dn: "STMDA - IUs which reached the criteria to stop MDA",
        },
        null,
      ],
    },
    {
      name: "IUs in post-treatment surveillance",
      type: rowTypes.PROGRAM_INDICATOR,
      cells: [
        { dn: "TCMDA - IUs in post-treatment surveillance" },
        { dn: "LFMDA - IUs in post-treatment surveillance" },
        null,
        null,
        { dn: "OMDA - IUs in post-treatment surveillance" },
        null,
        null,
        { dn: "SCMDA - IUs in post-treatment surveillance" },
        null,
        null,
        { dn: "STMDA - IUs in post-treatment surveillance" },
        null,
      ],
    },
    {
      name: "IUs eligible for post MDA surveillance phase",
      type: rowTypes.PROGRAM_INDICATOR,
      cells: [
        {
          dn: "TCMDA - IUs eligible for post MDA surveillance phase",
        },
        {
          dn: "LFMDA - IUs eligible for post MDA surveillance phase",
        },
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
      ],
    },
    {
      name: "IUs where NTD endemicity is unknown",
      type: rowTypes.PROGRAM_INDICATOR,
      cells: [
        { dn: "TCMDA - IUs where NTD endemicity is unknown" },
        { dn: "LFMDA - IUs where NTD endemicity is unknown" },
        null,
        null,
        { dn: "OMDA - IUs where NTD endemicity is unknown" },
        null,
        null,
        { dn: "SCMDA - IUs where NTD endemicity is unknown" },
        null,
        null,
        { dn: "STMDA - IUs where NTD endemicity is unknown" },
        null,
      ],
    },
    {
      name: "Population in NTD affected IUs",
      type: rowTypes.PROGRAM_INDICATOR,
      cells: [
        { dn: "TCMDA - Population in NTD affected IUs" },
        { dn: "LFMDA - Population in NTD affected IUs" },
        { dn: "OMDA - Population in NTD affected IUs Round 1" },
        { dn: "OMDA - Population in NTD affected IUs Round 2" },
        { dn: "OMDA - Population in NTD affected IUs Total" },
        { dn: "SCMDA - Population in NTD affected IUs Round 1" },
        { dn: "SCMDA - Population in NTD affected IUs Round 2" },
        { dn: "SCMDA - Population in NTD affected IUs Total" },
        { dn: "STMDA - Population in NTD affected IUs Round 1" },
        { dn: "STMDA - Population in NTD affected IUs Round 2" },
        { dn: "STMDA - Population in NTD affected IUs Total" },
        null,
      ],
    },
    {
      name: "IUs eligible for pre-TAS surveys",
      type: rowTypes.PROGRAM_INDICATOR,
      cells: [
        null,
        { dn: "LFMDA - IUs eligible for pre-TAS surveys" },
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
      ],
    },
    {
      name: "IUs eligible for TAS/IA surveys",
      type: rowTypes.PROGRAM_INDICATOR,
      cells: [
        { dn: "TCMDA - IUs eligible for TAS/IA surveys" },
        { dn: "LFMDA - IUs eligible for TAS/IA surveys" },
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
      ],
    },

    // Targets
    { name: "Targets", type: rowTypes.CATEGORY },
    {
      name: "Total Population of IUs",
      type: rowTypes.PROGRAM_INDICATOR,
      cells: [
        { dn: "TCMDA - Total Population of IUs" },
        { dn: "LFMDA - Total Population of IUs" },
        null,
        null,
        { dn: "OMDA - Total Population of IUs" },
        null,
        null,
        { dn: "SCMDA - Total Population of IUs" },
        null,
        null,
        { dn: "STMDA - Total Population of IUs" },
        { dn: "MDA - Total Population in Endemic IUs" },
      ],
    },
    {
      name: "Population eligible for MDA treatment",
      type: rowTypes.PROGRAM_INDICATOR,
      cells: [
        { dn: "TCMDA - Population eligible for MDA treatment" },
        { dn: "LFMDA - Population eligible for MDA treatment" },
        {
          dn: "OMDA - Population eligible for MDA treatment Round 1",
        },
        {
          dn: "OMDA - Population eligible for MDA treatment Round 2",
        },
        { dn: "OMDA - Population eligible for MDA treatment Total" },
        {
          dn: "SCMDA - Population eligible for MDA treatment Round 1",
        },
        {
          dn: "SCMDA - Population eligible for MDA treatment Round 2",
        },
        {
          dn: "SCMDA - Population eligible for MDA treatment Total",
        },
        {
          dn: "STMDA - Population eligible for MDA treatment Round 1",
        },
        {
          dn: "STMDA - Population eligible for MDA treatment Round 2",
        },
        {
          dn: "STMDA - Population eligible for MDA treatment Total",
        },
        {
          dn: "MDA - Total population eligible for MDA treatment of IU",
        },
      ],
    },
    {
      name: "Estimated size of populations with high risk of infection",
      type: rowTypes.PROGRAM_INDICATOR,
      cells: [
        {
          dn:
            "TCMDA - Estimated size of populations with high risk of infection",
        },
        {
          dn:
            "LFMDA - Estimated size of populations with high risk of infection",
        },
        {
          dn:
            "OMDA - Estimated size of populations with high risk of infection Round 1",
        },
        {
          dn:
            "OMDA - Estimated size of populations with high risk of infection Round 2",
        },
        {
          dn:
            "OMDA - Total estimated size of populations with high risk of infection",
        },
        {
          dn:
            "SCMDA - Estimated size of populations with high risk of infection Round 1",
        },
        {
          dn:
            "SCMDA - Estimated size of populations with high risk of infection Round 2",
        },
        {
          dn:
            "SCMDA - Total estimated size of populations with high risk of infection",
        },
        {
          dn:
            "STMDA - Estimated size of populations with high risk of infection Round 1",
        },
        {
          dn:
            "STMDA - Estimated size of populations with high risk of infection Round 2",
        },
        {
          dn:
            "STMDA - Total estimated size of populations with high risk of infection",
        },
        {
          dn:
            "MDA - Total Estimated size of populations with high risk of infection",
        },
      ],
    },

    // Coverage
    { name: "Coverage", type: rowTypes.CATEGORY },
    {
      name: "Geographic Coverage",
      type: rowTypes.INDICATOR,
      cells: [
        { dn: "TCMDA - Geographic Coverage" },
        { dn: "LFMDA - Geographic Coverage" },
        null,
        null,
        { dn: "OMDA - Geographic Coverage" },
        null,
        null,
        { dn: "SCMDA - Geographic Coverage" },
        null,
        null,
        { dn: "STMDA - Geographic Coverage" },
        null,
      ],
    },
    {
      name: "Program Coverage",
      type: rowTypes.PROGRAM_INDICATOR,
      cells: [
        { dn: "TCMDA - Program Coverage" },
        { dn: "LFMDA - Program Coverage" },
        { dn: "OMDA - Program Coverage Round 1" },
        { dn: "OMDA - Program Coverage Round 2" },
        null,
        { dn: "SCMDA - Program Coverage Round 1" },
        { dn: "SCMDA - Program Coverage Round 2" },
        null,
        { dn: "STMDA - Program Coverage Round 1" },
        { dn: "STMDA - Program Coverage Round 2" },
        null,
        null,
      ],
    },
    {
      // Same "division" error as above b/c TCMDA and LFMDA
      name: "Epidemiological Coverage",
      type: rowTypes.PROGRAM_INDICATOR,
      cells: [
        { value: "Oops! I cause a division by zero error." },
        { dn: "LFMDA - Epidemiological Coverage" },
        { dn: "OMDA - Epidemiological Coverage Round 1" },
        { dn: "OMDA - Epidemiological Coverage Round 2" },
        null,
        { dn: "SCMDA - Epidemiological Coverage Round 1" },
        { dn: "SCMDA - Epidemiological Coverage Round 2" },
        null,
        { dn: "STMDA - Epidemiological Coverage Round 1" },
        { dn: "STMDA - Epidemiological Coverage Round 2" },
        null,
        null,
      ],
    },
    {
      name: "IUs reaching targeted program coverage",
      type: rowTypes.PROGRAM_INDICATOR,
      cells: [
        { dn: "TCMDA - IUs reaching targeted program coverage" },
        { dn: "LFMDA - IUs reaching targeted program coverage" },
        { dn: "OMDA - IUs reaching targeted program coverage Round 1" },
        { dn: "OMDA - IUs reaching targeted program coverage Round 2" },
        null,
        { dn: "SCMDA - IUs reaching targeted program coverage Round 1" },
        { dn: "SCMDA - IUs reaching targeted program coverage Round 2" },
        null,
        { dn: "STMDA - IUs reaching targeted program coverage Round 1" },
        { dn: "STMDA - IUs reaching targeted program coverage Round 2" },
        null,
        null,
      ],
    },
    {
      name:
        "IUs reaching target therapeutic coverage within populations with high risk of infection",
      type: rowTypes.PROGRAM_INDICATOR,
      cells: [
        {
          dn:
            "TCMDA - IUs reaching target therapeutic coverage within populations with high risk of infection",
        },
        {
          dn:
            "LFMDA - IUs reaching target therapeutic coverage within populations with high risk of infection",
        },
        {
          dn:
            "OMDA - IUs reaching target therapeutic coverage within populations with high risk of infection Round 1",
        },
        {
          dn:
            "OMDA - IUs reaching target therapeutic coverage within populations with high risk of infection Round 2",
        },
        null,
        {
          dn:
            "SCMDA - IUs reaching target therapeutic coverage within populations with high risk of infection Round 1",
        },
        {
          dn:
            "SCMDA - IUs reaching target therapeutic coverage within populations with high risk of infection Round 2",
        },
        null,
        {
          dn:
            "STMDA - IUs reaching target therapeutic coverage within populations with high risk of infection Round 1",
        },
        {
          dn:
            "STMDA - IUs reaching target therapeutic coverage within populations with high risk of infection Round 2",
        },
        null,
        null,
      ],
    },
    {
      name: "IUs where MDA treatment has been provided",
      type: rowTypes.PROGRAM_INDICATOR,
      cells: [
        { dn: "TCMDA - IUs where MDA treatment has been provided" },
        { dn: "LFMDA - IUs where MDA treatment has been provided" },
        { dn: "OMDA - IUs where MDA treatment has been provided Round 1" },
        { dn: "OMDA - IUs where MDA treatment has been provided Round 2" },
        null,
        { dn: "SCMDA - IUs where MDA treatment has been provided Round 1" },
        { dn: "SCMDA - IUs where MDA treatment has been provided Round 2" },
        null,
        { dn: "STMDA - IUs where MDA treatment has been provided Round 1" },
        { dn: "STMDA - IUs where MDA treatment has been provided Round 2" },
        null,
        null,
      ],
    },
    {
      name: "MDA treatments distributed to high risk populations",
      type: rowTypes.PROGRAM_INDICATOR,
      cells: [
        null,
        {
          dn: "LFMDA - MDA treatments distributed to high risk populations",
        },
        {
          dn:
            "OMDA - MDA treatments distributed to high risk populations Round 1",
        },
        {
          dn:
            "OMDA - MDA treatments distributed to high risk populations Round 2",
        },
        {
          dn:
            "OMDA - Total MDA treatments distributed to high risk populations",
        },
        {
          dn:
            "SCMDA - MDA treatments distributed to high risk populations Round 1",
        },
        {
          dn:
            "SCMDA - MDA treatments distributed to high risk populations Round 2",
        },
        {
          dn:
            "SCMDA - Total MDA treatments distributed to high risk populations",
        },
        {
          dn:
            "STMDA - MDA treatments distributed to high risk populations Round 1",
        },
        {
          dn:
            "STMDA - MDA treatments distributed to high risk populations Round 2",
        },
        {
          dn:
            "STMDA - Total MDA treatments distributed to high risk populations",
        },
        {
          dn: "MDA - Total MDA treatments distributed to high risk populations",
        },
      ],
    },
    // Display name: "Number of PC treatments provided per IU (per disease)"
    {
      name: "Number of PC treatments provided per IU",
      type: rowTypes.PROGRAM_INDICATOR,
      cells: [
        { dn: "TCMDA - Total Persons Treated" },
        { dn: "LFMDA - Total Persons Treated" },
        { dn: "OMDA - Total Persons Treated Round 1" },
        { dn: "OMDA - Total Persons Treated Round 2" },
        { dn: "OMDA - Total Persons Treated Round 1 AND 2" },
        { dn: "SCMDA - Total Persons Treated Round 1" },
        { dn: "SCMDA - Total Persons Treated Round 2" },
        { dn: "SCMDA - Total Persons Treated Round 1 AND 2" },
        { dn: "STMDA - Total Persons Treated Round 1" },
        { dn: "STMDA - Total Persons Treated Round 2" },
        { dn: "STMDA - Total Persons Treated Round 1 AND 2" },
        { dn: "MDA - Total PC treatments provided" },
      ],
    },
    {
      name: "IUs where MDA campaigns were conducted",
      type: rowTypes.PROGRAM_INDICATOR,
      cells: [
        { dn: "TCMDA - IUs where MDA campaigns were conducted" },
        { dn: "LFMDA - IUs where MDA campaigns were conducted" },
        { dn: "OMDA - IUs where MDA campaigns were conducted Round 1" },
        { dn: "OMDA - IUs where MDA campaigns were conducted Round 2" },
        { dn: "OMDA - Total IUs where MDA campaigns were conducted" },
        { dn: "SCMDA - IUs where MDA campaigns were conducted Round 1" },
        { dn: "SCMDA - IUs where MDA campaigns were conducted Round 2" },
        { dn: "SCMDA - Total IUs where MDA campaigns were conducted" },
        { dn: "STMDA - IUs where MDA campaigns were conducted Round 1" },
        { dn: "STMDA - IUs where MDA campaigns were conducted Round 2" },
        { dn: "STMDA - Total IUs where MDA campaigns were conducted" },
        null,
      ],
    },
    {
      name: "IUs reaching required therapeutic coverage",
      type: rowTypes.PROGRAM_INDICATOR,
      cells: [
        { dn: "TCMDA - IUs reaching required therapeutic coverage" },
        { dn: "LFMDA - IUs reaching required therapeutic coverage" },
        { dn: "OMDA - IUs reaching required therapeutic coverage Round 1" },
        { dn: "OMDA - IUs reaching required therapeutic coverage Round 2" },
        null,
        { dn: "SCMDA - IUs reaching required therapeutic coverage Round 1" },
        { dn: "SCMDA - IUs reaching required therapeutic coverage Round 2" },
        null,
        { dn: "STMDA - IUs reaching required therapeutic coverage Round 1" },
        { dn: "STMDA - IUs reaching required therapeutic coverage Round 2" },
        null,
        null,
      ],
    },
    {
      name:
        "Number of people, in population eligible for treatment, receiving MDA treatment",
      type: rowTypes.PROGRAM_INDICATOR,
      cells: [
        { dn: "TCMDA - Total Persons Treated" },
        { dn: "LFMDA - Total Persons Treated" },
        { dn: "OMDA - Total Persons Treated Round 1" },
        { dn: "OMDA - Total Persons Treated Round 2" },
        { dn: "OMDA - Total Persons Treated Round 1 AND 2" },
        { dn: "SCMDA - Total Persons Treated Round 1" },
        { dn: "SCMDA - Total Persons Treated Round 2" },
        { dn: "SCMDA - Total Persons Treated Round 1 AND 2" },
        { dn: "STMDA - Total Persons Treated Round 1" },
        { dn: "STMDA - Total Persons Treated Round 2" },
        { dn: "STMDA - Total Persons Treated Round 1 AND 2" },
        null,
      ],
    },
    {
      name:
        "Number of People, in population eligible for treatment, not receiving MDA treatment",
      type: rowTypes.PROGRAM_INDICATOR,
      cells: [
        {
          dn:
            "TCMDA - People, in population eligible for treatment, not receiving MDA treatment",
        },
        {
          dn:
            "LFMDA - People, in population eligible for treatment, not receiving MDA treatment",
        },
        {
          dn:
            "OMDA - People, in population eligible for treatment, not receiving MDA treatment Round 1",
        },
        {
          dn:
            "OMDA - People, in population eligible for treatment, not receiving MDA treatment Round 2",
        },
        {
          dn:
            "OMDA - Total People, in population eligible for treatment, not receiving MDA treatment",
        },
        {
          dn:
            "SCMDA - People, in population eligible for treatment, not receiving MDA treatment Round 1",
        },
        {
          dn:
            "SCMDA - People, in population eligible for treatment, not receiving MDA treatment Round 2",
        },
        {
          dn:
            "SCMDA - Total People, in population eligible for treatment, not receiving MDA treatment",
        },
        {
          dn:
            "STMDA - People, in population eligible for treatment, not receiving MDA treatment Round 1",
        },
        {
          dn:
            "STMDA - People, in population eligible for treatment, not receiving MDA treatment Round 2",
        },
        {
          dn:
            "STMDA - Total People, in population eligible for treatment, not receiving MDA treatment",
        },
        // Additional space here
        {
          dn:
            "MDA - Total People, in population eligible for treatment, not receiving MDA treatment",
        },
      ],
    },
    {
      name: "IU supported with NTD MDA treatment planning and coordination",
      type: rowTypes.PROGRAM_INDICATOR,
      cells: [
        {
          dn:
            "TCMDA - IU supported with NTD MDA treatment planning and coordination",
        },
        {
          dn:
            "LFMDA - IU supported with NTD MDA treatment planning and coordination",
        },
        {
          dn:
            "OMDA - IU supported with NTD MDA treatment planning and coordination Round 1",
        },
        {
          dn:
            "OMDA - IU supported with NTD MDA treatment planning and coordination Round 2",
        },
        {
          customLogic: (idx, row) =>
            greatestOf(row[idx - 1].value, row[idx - 2].value),
        },
        {
          dn:
            "SCMDA - IU supported with NTD MDA treatment planning and coordination Round 1",
        },
        {
          dn:
            "SCMDA - IU supported with NTD MDA treatment planning and coordination Round 2",
        },
        {
          customLogic: (idx, row) =>
            greatestOf(row[idx - 1].value, row[idx - 2].value),
        },
        {
          dn:
            "STMDA - IU supported with NTD MDA treatment planning and coordination Round 1",
        },
        {
          dn:
            "STMDA - IU supported with NTD MDA treatment planning and coordination Round 2",
        },
        {
          customLogic: (idx, row) =>
            greatestOf(row[idx - 1].value, row[idx - 2].value),
        },
        null,
      ],
    },

    // Coverage evaluation
    { name: "Coverage Evaluation", type: rowTypes.CATEGORY },
    {
      name:
        "IUs where MDA treatment coverage was verified and addressed using SCT",
      type: rowTypes.PROGRAM_INDICATOR,
      cells: [
        {
          dn:
            "TCMDA - IUs where MDA treatment coverage was verified and addressed using SCT",
        },
        {
          dn:
            "LFMDA - IUs where MDA treatment coverage was verified and addressed using SCT",
        },
        {
          dn:
            "OMDA - IUs where MDA treatment coverage was verified and addressed using SCT Round 1",
        },
        {
          dn:
            "OMDA - IUs where MDA treatment coverage was verified and addressed using SCT Round 2",
        },
        {
          customLogic: (idx, row) =>
            greatestOf(row[idx - 1].value, row[idx - 2].value),
        },
        {
          dn:
            "SCMDA - IUs where MDA treatment coverage was verified and addressed using SCT Round 1",
        },
        {
          dn:
            "SCMDA - IUs where MDA treatment coverage was verified and addressed using SCT Round 2",
        },
        {
          customLogic: (idx, row) =>
            greatestOf(row[idx - 1].value, row[idx - 2].value),
        },
        {
          dn:
            "STMDA - IUs where MDA treatment coverage was verified and addressed using SCT Round 1",
        },
        {
          dn:
            "STMDA - IUs where MDA treatment coverage was verified and addressed using SCT Round 2",
        },
        {
          customLogic: (idx, row) =>
            greatestOf(row[idx - 1].value, row[idx - 2].value),
        },
        {
          customLogic: (idx, row) =>
            sumOf(
              row[0].value,
              row[1].value,
              row[4].value,
              row[7].value,
              row[10].value
            ),
        }, // TODO: sum
      ],
    },
    {
      name: "IUs not meeting the cut-off value for SCT",
      type: rowTypes.PROGRAM_INDICATOR,
      cells: [
        { dn: "TCMDA - IUs not meeting the cut-off value for SCT" },
        { dn: "LFMDA - IUs not meeting the cut-off value for SCT" },
        { dn: "OMDA - IUs not meeting the cut-off value for SCT Round 1" },
        { dn: "OMDA - IUs not meeting the cut-off value for SCT Round 2" },
        {
          customLogic: (idx, row) =>
            greatestOf(row[idx - 1].value, row[idx - 2].value),
        },
        { dn: "SCMDA - IUs not meeting the cut-off value for SCT Round 1" },
        { dn: "SCMDA - IUs not meeting the cut-off value for SCT Round 2" },
        {
          customLogic: (idx, row) =>
            greatestOf(row[idx - 1].value, row[idx - 2].value),
        },
        { dn: "STMDA - IUs not meeting the cut-off value for SCT Round 1" },
        { dn: "STMDA - IUs not meeting the cut-off value for SCT Round 2" },
        {
          customLogic: (idx, row) =>
            greatestOf(row[idx - 1].value, row[idx - 2].value),
        },
        {
          customLogic: (idx, row) =>
            sumOf(
              row[0].value,
              row[1].value,
              row[4].value,
              row[7].value,
              row[10].value
            ),
        }, // No sum?
      ],
    },
    {
      name:
        "Number of evaluation areas where mob-up activites were conducted following a SCT",
      dnBase: "",
      type: rowTypes.PROGRAM_INDICATOR,
      cells: [], // Todo
    },
    {
      name:
        "Number of IUs for which independent representative coverage surveys according to WHO guidelines were completed",
      dnBase: "",
      type: rowTypes.PROGRAM_INDICATOR,
      cells: [], // Todo
    },

    // LNOB
    { name: "LNOB", type: rowTypes.CATEGORY },
    {
      name:
        "Number of people from marginilized groups (LNOB) who received NTD MDA treatment",
      dnBase: "",
      type: rowTypes.PROGRAM_INDICATOR,
      cells: [], // TODO
      // Grand total: { dn: "MDA - Total people from marginalized groups (LNOB) who received NTD MDA treatment"}
    },
  ]; // End row definitions

  // Functions
  function greatestOf(...args) {
    const nums = args.filter((n) => !isNaN(n));
    if (!nums.length) return 0;
    return Math.max(...nums);
  }

  function sumOf(...args) {
    const nums = args.filter((n) => !isNaN(n));
    if (!nums.length) return 0;
    return nums.reduce((sum, n) => sum + Number(n), 0);
  }

  function getAllDimensions() {
    // Gets a list of all indicators' and program indicators' names and IDs
    return Promise.all([
      $.get(
        "../api/programIndicators.json?filter=displayName:like:MDA&paging=false"
      ),
      $.get("../api/indicators.json?filter=displayName:like:MDA&paging=false"),
    ]).then((values) => {
      const [{ programIndicators }, { indicators }] = values;
      const allDimensions = [...programIndicators, ...indicators];

      // Convert to a Map where keys are names and values are ids for lookup
      // const keyValuePairs = allDimensions.map(dimension => {
      //   return [dimension.displayName, dimension.id];
      // })
      // const dimensionsMap = new Map(keyValuePairs);

      return allDimensions;
    });
  }

  function populateCellDimensionIds(allDimensions) {
    // Also populates `state.dimensionsToQuery`
    const dimensionsToQuery = [];

    // Look up dimension ids by name and add ids to cells
    rows.forEach(({ cells }) => {
      if (!cells) return;

      cells.forEach((cell) => {
        if (!cell || !cell.dn) return;
        const { dn: dimensionName } = cell;
        // if (!dimensionName) return;

        const dimension = allDimensions.find(
          (dim) => dim.displayName === dimensionName
        );
        if (!dimension) {
          cell.value = `(dimension not found: ${dimensionName})`;
          return;
        }

        // Dimension found: populate `id` on cell and add it to list to query
        dimensionsToQuery.push(dimension.id);
        cell.dId = dimension.id;
      });
    });

    state = { ...state, dimensionsToQuery };
    return dimensionsToQuery;
  }

  function populateHtmlTableHeader() {
    // Remove "loading"
    $("#loading").remove();

    $("#header-row-top").append(`<th scope="col"></th>`);
    $("#header-row-bottom").append(`<th scope="col"></th>`);
    columns.forEach((col) => {
      if (col.subcategories) {
        // 1. Make the top row th colspan = col.subcategories.length
        $("#header-row-top").append(
          `<th scope="col" colspan="${col.subcategories.length}">${col.name}</th>`
        );
        // 2. Make a bottom row th for each subcategory
        col.subcategories.forEach((subcat) => {
          $("#header-row-bottom").append(
            `<th scope="col">${subcat.shortName}</th>`
          );
        });
        return;
      }
      // Else, th with col name on top header row, empty cell on bottom
      $("#header-row-top").append(`<th scope=col>${col.shortName}</th>`);
      $("#header-row-bottom").append(`<th scope="col"></th>`);
    });
  }

  function getAnalyticsData(/* dimensionsToQuery, period, orgUnit */) {
    const { dimensionsToQuery, period, orgUnit } = state;
    return $.get("../api/analytics", {
      dimension: `dx:${dimensionsToQuery.join(";")},pe:${period}`,
      filter: `ou:${orgUnit}`,
      skipMeta: true,
    }).then((json) => {
      // convert to a map for easy lookup by ID:
      const keyValuePairs = json.rows.map((row) => [row[0], row[2]]);
      const resultsMap = new Map(keyValuePairs);
      return resultsMap;
    });
  }

  function populateCellValues(analyticsResults) {
    // Use dimensionId or customLogic to populate value
    rows.forEach(({ cells }) => {
      if (!cells) return; // Empty row; return

      cells.forEach((cell, idx, arr) => {
        // (get `idx` and `arr` values for custom logic functions)
        if (!cell) return;
        const { dId: dimensionId, customLogic } = cell;

        if (dimensionId) {
          const data = analyticsResults.get(dimensionId);
          cell.value = data || "-";
          return;
        }

        if (customLogic) {
          cell.value = customLogic(idx, arr); // for example
          return;
        }
      });
    });
  }

  function populateHtmlTableBodyWithValues() {
    // Clear tbody for fresh rows
    const tbody = $("#tbody").empty();

    // Set up table body to be populated
    const totalColumns =
      1 +
      columns.reduce(
        (sum, column) => sum + (column.subcategories?.length || 1),
        0
      );

    // Set up table body
    rows.forEach((row) => {
      // Make new row element
      const newRow = $(
        `<tr data-name="${row.name}" data-type="${row.type}"></tr>`
      );
      // Add new row to DOM
      tbody.append(newRow);

      if (row.type === rowTypes.CATEGORY) {
        // Row is just a category label (like "Coverage Evaluation"): make one wide cell and return
        newRow.append(
          `<th scope="row" colspan="${totalColumns}">${row.name}</th>`
        );
        return;
      }

      // Add row header with name
      newRow.append(`<th scope="row">${row.name}</th>`);

      if (!row.cells || !row.cells.length) {
        newRow.append(
          `<td colspan="${totalColumns - 1}">No dimensions specified</td>`
        );
        return;
      }

      row.cells.forEach((cell) => {
        // If cell is empty or has no value, make empty cell element
        if (!cell || typeof cell.value === "undefined")
          return newRow.append(`<td></td>`);
        const { value } = cell;
        newRow.append(`<td>${value}</td>`);
      });
    });
  }

  function handleChange(e) {
    state = { ...state, [e.target.name]: e.target.value };
    $("#tbody").empty().text("Loading data...");
    getAnalyticsData()
      .then(populateCellValues)
      .then(populateHtmlTableBodyWithValues);
  }

  function setUpForm() {
    $("#periodSelect").on("change", handleChange);
    $("#orgUnitSelect").on("change", handleChange);
  }

  jQuery(document).ready(function () {
    // Javascript to be executed after page is loaded here

    getAllDimensions()
      .then(populateCellDimensionIds)
      .then(getAnalyticsData)
      .then(populateCellValues)
      .then(populateHtmlTableHeader)
      .then(populateHtmlTableBodyWithValues)
      .then(setUpForm)
      .catch(console.error);
  });
</script>

<!-- Bootstrap test -->
<link
  rel="stylesheet"
  href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
  integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
  crossorigin="anonymous"
/>

<div>
  <!-- Put your HTML mark-up here -->

  <h4>Notes:</h4>
  <p>
    So we can make sure we're querying the right things, "dimension not found"
    indicates fields that weren't found in the lists of indicators or program
    indicators. Of course, some of them should be blank in the end.
  </p>
  <p>
    A cell showing "-" means that the dimension <em>was</em> found, but no data
    was found for it in the database.
  </p>

  <hr />

  <h1>MDA Treatment Summary</h1>

  <div class="form-group">
    <label for="periodSelect">Period:</label>
    <select name="period" id="periodSelect" class="form-control">
      <option value="2020">2020</option>
      <option value="2019">2019</option>
    </select>
  </div>

  <div class="form-group">
    <label for="orgUnitSelect">Organisation Unit:</label>
    <select name="orgUnit" id="orgUnitSelect" class="form-control">
      <option value="GdH306UQ8L8">ASCEND (Global)</option>
      <option value="NcFgAaXhz7C">Bangladesh</option>
      <option value="AE6IvE2jiSd">Ethiopia</option>
      <option value="TDzGT1zy5Ay">Kenya</option>
      <option value="Ej29Oagyhzo">Malawi</option>
      <option value="dDWimYQWqK3">Mozambique</option>
      <option value="cDXNddYCdPh">South Sudan</option>
      <option value="FqoRMDOhFAp">Tanzania</option>
      <option value="IHyDQqsAo7k">Tanzania, Zanzibar</option>
      <option value="Yz1I2quJvaQ">Uganda</option>
      <option value="AK2b9x2HipG">Zambia</option>
      <option value="zzkzrWcJnfM">ZZ TEST</option>
    </select>
  </div>

  <p id="loading">Loading...</p>

  <table id="table1" class="table">
    <thead id="thead">
      <tr id="header-row-top">
        <!-- Script will populate col headers here -->
      </tr>
      <tr id="header-row-bottom">
        <!-- Script will populate col subheaders here-->
      </tr>
    </thead>
    <tbody id="tbody">
      <!-- Script will populate rows here -->
    </tbody>
  </table>
</div>
